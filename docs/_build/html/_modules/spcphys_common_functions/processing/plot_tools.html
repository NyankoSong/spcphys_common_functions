

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>spcphys_common_functions.processing.plot_tools &mdash; spcphys_common_functions  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            spcphys_common_functions
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">spcphys_common_functions</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">spcphys_common_functions.processing.plot_tools</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for spcphys_common_functions.processing.plot_tools</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;Module for plotting tools.&#39;&#39;&#39;</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Iterable</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">stats</span> <span class="k">as</span> <span class="n">astats</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">LogNorm</span><span class="p">,</span> <span class="n">Normalize</span>
<span class="kn">from</span> <span class="nn">matplotlib.collections</span> <span class="kn">import</span> <span class="n">QuadMesh</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">convolve2d</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>

<span class="kn">from</span> <span class="nn">..utils.utils</span> <span class="kn">import</span> <span class="n">check_parameters</span>


<span class="k">def</span> <span class="nf">_determine_bins</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">scale</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">astats</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">scale</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">astats</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
        <span class="n">bins</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">bins</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;scale must be &#39;linear&#39; or &#39;log&#39;&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bins</span>


<span class="k">def</span> <span class="nf">_log_or_linear_plot</span><span class="p">(</span><span class="n">scales</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">ax</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    
    <span class="k">if</span> <span class="n">scales</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span> <span class="ow">and</span> <span class="n">scales</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">plt</span><span class="o">.</span><span class="n">loglog</span> <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ax</span><span class="o">.</span><span class="n">loglog</span>
    <span class="k">elif</span> <span class="n">scales</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span> <span class="ow">and</span> <span class="n">scales</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span> <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ax</span><span class="o">.</span><span class="n">semilogx</span>
    <span class="k">elif</span> <span class="n">scales</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span> <span class="ow">and</span> <span class="n">scales</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span> <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ax</span><span class="o">.</span><span class="n">semilogy</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span> <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span>


<span class="k">def</span> <span class="nf">_logarithmic_error</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">log_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">log_x_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">log_x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">unlog_x_mean</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">log_x_mean</span>
    <span class="n">log_x_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">log_x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># log_x_err = np.abs(log_x_std/log_x_mean/2.303) # 废弃，此方法并不是这么用的，而是用于没有原始数据的观测数据，例如只提供了均值和标准差</span>
    <span class="c1"># x_cap = [np.abs(x_mid - 10**(log_x_mean - log_x_err)),  np.abs(x_mid - 10**(log_x_mean + log_x_err))]</span>
    <span class="n">x_cap</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">unlog_x_mean</span> <span class="o">-</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">log_x_mean</span> <span class="o">-</span> <span class="n">log_x_std</span><span class="p">)),</span>  <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">unlog_x_mean</span> <span class="o">-</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">log_x_mean</span> <span class="o">+</span> <span class="n">log_x_std</span><span class="p">))]</span>
    <span class="k">return</span> <span class="n">unlog_x_mean</span><span class="p">,</span> <span class="n">log_x_std</span><span class="p">,</span> <span class="n">x_cap</span>


<span class="k">def</span> <span class="nf">_mean_std_params</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">scale</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
        <span class="n">unlog_x_mean</span><span class="p">,</span> <span class="n">log_x_std</span><span class="p">,</span> <span class="n">x_cap</span> <span class="o">=</span> <span class="n">_logarithmic_error</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$x=10\^($&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">unlog_x_mean</span><span class="p">)</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;$\pm$&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">log_x_std</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;$)$&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x_mean</span><span class="p">,</span> <span class="n">x_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">x_cap</span> <span class="o">=</span> <span class="p">[</span><span class="n">x_err</span><span class="p">,</span> <span class="n">x_err</span><span class="p">]</span>
        <span class="n">x_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$x=$&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x_mean</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;$\pm$&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x_err</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="k">return</span> <span class="n">unlog_x_mean</span><span class="p">,</span> <span class="n">x_cap</span><span class="p">,</span> <span class="n">x_label</span>


<span class="k">def</span> <span class="nf">_mean_std_line_params</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x_edges</span><span class="p">,</span> <span class="n">scale</span><span class="p">):</span>
    <span class="n">unlog_y_means</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">y_caps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_edges</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">unlog_y_mean</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">y_cap</span> <span class="o">=</span> <span class="n">_logarithmic_error</span><span class="p">(</span><span class="n">y</span><span class="p">[(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">x_edges</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">x_edges</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])])</span>
            <span class="n">unlog_y_means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unlog_y_mean</span><span class="p">)</span>
            <span class="n">y_caps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_cap</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_edges</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">y_window</span> <span class="o">=</span> <span class="n">y</span><span class="p">[(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">x_edges</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">x_edges</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])]</span>
            <span class="n">y_mean</span><span class="p">,</span> <span class="n">y_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">y_window</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">y_window</span><span class="p">)</span>
            <span class="n">unlog_y_means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_mean</span><span class="p">)</span>
            <span class="n">y_caps</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">y_err</span><span class="p">,</span> <span class="n">y_err</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">unlog_y_means</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_caps</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>


<div class="viewcode-block" id="plot_hist2d">
<a class="viewcode-back" href="../../../source/spcphys_common_functions.processing.html#spcphys_common_functions.processing.plot_tools.plot_hist2d">[docs]</a>
<span class="nd">@check_parameters</span>
<span class="k">def</span> <span class="nf">plot_hist2d</span><span class="p">(</span><span class="n">axes</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">|</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">|</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">|</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="o">|</span><span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">least_samples_per_cell</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">scales</span><span class="p">:</span> <span class="nb">list</span><span class="o">|</span><span class="nb">tuple</span><span class="o">|</span><span class="nb">str</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">norm_type</span><span class="p">:</span> <span class="nb">str</span><span class="o">|</span><span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">color_norm_type</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">color_norm_range</span><span class="p">:</span> <span class="nb">list</span><span class="o">|</span><span class="nb">tuple</span><span class="o">|</span><span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bins</span><span class="p">:</span> <span class="nb">int</span><span class="o">|</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">|</span><span class="nb">list</span><span class="o">|</span><span class="nb">str</span><span class="o">=</span><span class="s1">&#39;freedman&#39;</span><span class="p">,</span> <span class="n">hist_pcolormesh_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="o">|</span><span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">contour_levels</span><span class="p">:</span> <span class="nb">list</span><span class="o">|</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">|</span><span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">contour_smooth</span><span class="p">:</span> <span class="nb">int</span><span class="o">|</span><span class="nb">float</span><span class="o">|</span><span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">contour_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="o">|</span><span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">fit_line</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fit_line_plot_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="o">|</span><span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">mean_std</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mean_std_errorbar_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="o">|</span><span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">separate</span><span class="p">:</span> <span class="nb">str</span><span class="o">|</span><span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">mean_std_line</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mean_std_line_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="o">|</span><span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QuadMesh</span><span class="p">:</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Plot a 2D histogram. If z is provided, overplot z as color.</span>

<span class="sd">    :param axes: The matplotlib axes to plot on.</span>
<span class="sd">    :param x: The x-axis data, can be a numpy array or an astropy Quantity.</span>
<span class="sd">    :param y: The y-axis data, can be a numpy array or an astropy Quantity.</span>
<span class="sd">    :param z: The z-axis data, can be a numpy array or an astropy Quantity. Default is None.</span>
<span class="sd">    :param least_samples_per_cell: The least number of samples per cell to plot, valid only when z is not None. Default is 0.</span>
<span class="sd">    :param scales: The scales for the axes, can be &#39;linear&#39; or &#39;log&#39;. Default is &#39;linear&#39;.</span>
<span class="sd">    :param norm_type: The normalization type, can be &#39;max&#39;, &#39;sum&#39;, or None. Default is None.</span>
<span class="sd">    :param color_norm_type: The color normalization type, can be &#39;linear&#39; or &#39;log&#39;. Default is &#39;linear&#39;.</span>
<span class="sd">    :param color_norm_range: The range for color normalization. Default is None.</span>
<span class="sd">    :param bins: The bins for the histogram, can be an integer, numpy array, list, or a string (&#39;freedman&#39;, &#39;scott&#39;, &#39;knuth&#39;, &#39;blocks&#39;). Default is &#39;freedman&#39;.</span>
<span class="sd">    :param hist_pcolormesh_kwargs: Additional arguments for pcolormesh. Default is {&#39;cmap&#39;:&#39;jet&#39;}.</span>
<span class="sd">    :param contour_levels: The levels for contour plotting. Default is None.</span>
<span class="sd">    :param contour_smooth: The smoothing parameter for contours. Default is None.</span>
<span class="sd">    :param contour_kwargs: Additional arguments for contour plotting. Default is {}.</span>
<span class="sd">    :param fit_line: Whether to fit a line to the data. Default is False.</span>
<span class="sd">    :param fit_line_plot_kwargs: Arguments for plotting the fit line. Default is {&#39;color&#39;:&#39;k&#39;, &#39;linestyle&#39;:&#39;--&#39;, &#39;linewidth&#39;:1}.</span>
<span class="sd">    :param mean_std: Whether to plot mean and standard deviation. Default is False.</span>
<span class="sd">    :param mean_std_errorbar_kwargs: Arguments for plotting error bars of mean and standard deviation. Default is {&#39;fmt&#39;:&#39;none&#39;, &#39;color&#39;:&#39;k&#39;, &#39;capsize&#39;:2}.</span>
<span class="sd">    :param separate: Whether to normalize separately along &#39;x&#39; or &#39;y&#39; axis. Default is None.</span>
<span class="sd">    :param mean_std_line: Whether to plot a line for mean and standard deviation. Default is False.</span>
<span class="sd">    :param mean_std_line_kwargs: Arguments for plotting the mean and standard deviation line. Default is {&#39;fmt&#39;:&#39;o&#39;, &#39;ms&#39;:2, &#39;color&#39;:&#39;k&#39;, &#39;capsize&#39;:2, &#39;linewidth&#39;:1, &#39;linestyle&#39;:&#39;-&#39;}.</span>
<span class="sd">    </span>
<span class="sd">    :return quadmesh: The QuadMesh object of the 2D histogram.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">if</span> <span class="n">least_samples_per_cell</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;least_samples_per_cell must be a positive integer.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">norm_type</span> <span class="ow">and</span> <span class="n">norm_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;norm_type must be &#39;max&#39;, &#39;sum&#39; or None.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">color_norm_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="s1">&#39;linear&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;color_norm_type must be &#39;log&#39; or &#39;linear&#39;.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">bins</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;freedman&#39;</span><span class="p">,</span> <span class="s1">&#39;scott&#39;</span><span class="p">,</span> <span class="s1">&#39;knuth&#39;</span><span class="p">,</span> <span class="s1">&#39;blocks&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;bins must be &#39;freedman&#39;, &#39;scott&#39;, &#39;knuth&#39;, &#39;blocks&#39;, an integer, a numpy array, or a list.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">separate</span> <span class="ow">and</span> <span class="n">separate</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;separate must be &#39;x&#39;, &#39;y&#39; or None.&quot;</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">hist_pcolormesh_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">hist_pcolormesh_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;cmap&#39;</span><span class="p">:</span><span class="s1">&#39;jet&#39;</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">contour_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">contour_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">fit_line_plot_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fit_line_plot_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;color&#39;</span><span class="p">:</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;linestyle&#39;</span><span class="p">:</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="s1">&#39;linewidth&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">mean_std_errorbar_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mean_std_errorbar_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fmt&#39;</span><span class="p">:</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">:</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;capsize&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">mean_std_line_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mean_std_line_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fmt&#39;</span><span class="p">:</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="s1">&#39;ms&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">:</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;capsize&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;linewidth&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;linestyle&#39;</span><span class="p">:</span><span class="s1">&#39;-&#39;</span><span class="p">}</span>
        

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">value</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">value</span>
    
    
    <span class="n">bins</span> <span class="o">=</span> <span class="p">[</span><span class="n">bins</span><span class="p">,</span> <span class="n">bins</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span> <span class="nb">str</span><span class="o">|</span><span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">bins</span>
    <span class="n">scales</span> <span class="o">=</span> <span class="p">[</span><span class="n">scales</span><span class="p">,</span> <span class="n">scales</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scales</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">z</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">scales</span><span class="p">,</span> <span class="n">scales</span><span class="p">,</span> <span class="n">scales</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scales</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">scales</span>
    
    <span class="n">bins_x</span> <span class="o">=</span> <span class="n">_determine_bins</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">scales</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">bins_y</span> <span class="o">=</span> <span class="n">_determine_bins</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">scales</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="n">z_hist</span><span class="p">,</span> <span class="n">x_edges</span><span class="p">,</span> <span class="n">y_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="n">bins_x</span><span class="p">,</span> <span class="n">bins_y</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">z_hist</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No enough data to plot 2D histogram.&quot;</span><span class="p">)</span>
        
    <span class="n">x_mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">x_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">y_mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">y_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    
    <span class="k">if</span> <span class="n">z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">z_scaled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="k">if</span> <span class="n">scales</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span> <span class="k">else</span> <span class="n">z</span>
        <span class="n">z_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">z_hist</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_edges</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_edges</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">z_jk</span> <span class="o">=</span> <span class="n">z_scaled</span><span class="p">[(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">x_edges</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">x_edges</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">y_edges</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;=</span> <span class="n">y_edges</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])]</span>
                <span class="n">z_mat</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">z_jk</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">z_jk</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">least_samples_per_cell</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">z_mat</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">z_mat</span> <span class="k">if</span> <span class="n">scales</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span> <span class="k">else</span> <span class="n">z_mat</span>
        
        <span class="k">if</span> <span class="n">scales</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
            <span class="n">color_norm</span> <span class="o">=</span> <span class="n">LogNorm</span><span class="p">(</span><span class="o">*</span><span class="n">color_norm_range</span><span class="p">)</span> <span class="k">if</span> <span class="n">color_norm_range</span> <span class="k">else</span> <span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">z_mat</span><span class="p">),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">z_mat</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">scales</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
            <span class="n">color_norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="o">*</span><span class="n">color_norm_range</span><span class="p">)</span> <span class="k">if</span> <span class="n">color_norm_range</span> <span class="k">else</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">z_mat</span><span class="p">),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">z_mat</span><span class="p">))</span>
            
        <span class="n">quadmesh</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">x_edges</span><span class="p">,</span> <span class="n">y_edges</span><span class="p">,</span> <span class="n">z_mat</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">color_norm</span><span class="p">,</span> <span class="o">**</span><span class="n">hist_pcolormesh_kwargs</span><span class="p">)</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">norm_type</span> <span class="o">==</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">separate</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
                <span class="n">z_hist</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">z_hist</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">separate</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="n">z_hist</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">z_hist</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">z_hist</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">z_hist</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">norm_type</span> <span class="o">==</span> <span class="s1">&#39;sum&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">separate</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
                <span class="n">z_hist</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">z_hist</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">separate</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="n">z_hist</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">z_hist</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">z_hist</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">z_hist</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">color_norm_type</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
            <span class="n">color_norm</span> <span class="o">=</span> <span class="n">LogNorm</span><span class="p">(</span><span class="o">*</span><span class="n">color_norm_range</span><span class="p">)</span> <span class="k">if</span> <span class="n">color_norm_range</span> <span class="k">else</span> <span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">z_hist</span><span class="p">[</span><span class="n">z_hist</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">z_hist</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">color_norm_type</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
            <span class="n">color_norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="o">*</span><span class="n">color_norm_range</span><span class="p">)</span> <span class="k">if</span> <span class="n">color_norm_range</span> <span class="k">else</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">z_hist</span><span class="p">),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">z_hist</span><span class="p">))</span>
        
        <span class="n">z_masked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">z_hist</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">z_hist</span><span class="p">)</span>
        <span class="n">quadmesh</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">x_edges</span><span class="p">,</span> <span class="n">y_edges</span><span class="p">,</span> <span class="n">z_masked</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">color_norm</span><span class="p">,</span> <span class="o">**</span><span class="n">hist_pcolormesh_kwargs</span><span class="p">)</span>
    
        <span class="k">if</span> <span class="ow">not</span> <span class="n">separate</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">contour_levels</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">contour_smooth</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">contour_smooth</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">int</span><span class="p">(</span><span class="n">contour_smooth</span><span class="p">)</span> <span class="o">==</span> <span class="n">contour_smooth</span><span class="p">:</span>
                        <span class="n">z_hist</span> <span class="o">=</span> <span class="n">convolve2d</span><span class="p">(</span><span class="n">z_hist</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">contour_smooth</span><span class="p">,</span> <span class="n">contour_smooth</span><span class="p">)),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">contour_smooth</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                        <span class="n">z_hist</span> <span class="o">=</span> <span class="n">convolve2d</span><span class="p">(</span><span class="n">z_hist</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">contour_smooth</span><span class="o">*</span><span class="n">z_hist</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">contour_smooth</span><span class="o">*</span><span class="n">z_hist</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
                <span class="n">axes</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">x_mid</span><span class="p">,</span> <span class="n">y_mid</span><span class="p">,</span> <span class="n">z_hist</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">contour_levels</span><span class="p">,</span> <span class="o">**</span><span class="n">contour_kwargs</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">fit_line</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">scales</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
                    <span class="n">x_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">x_fit</span> <span class="o">=</span> <span class="n">x</span>
                <span class="k">if</span> <span class="n">scales</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
                    <span class="n">y_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">y_fit</span> <span class="o">=</span> <span class="n">y</span>
                    
                <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">r_value</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">x_fit</span><span class="p">,</span> <span class="n">y_fit</span><span class="p">)</span>
                <span class="n">x_fitted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">x_fit</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">x_fit</span><span class="p">)])</span>
                <span class="n">y_fitted</span> <span class="o">=</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">x_fitted</span> <span class="o">+</span> <span class="n">intercept</span>
                
                <span class="k">if</span> <span class="n">scales</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
                    <span class="n">x_fitted</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">x_fitted</span>
                    <span class="n">right_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">slope</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;$\log_</span><span class="si">{10}</span><span class="s1">x$&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">right_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">slope</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;$x$&#39;</span>
                <span class="k">if</span> <span class="n">scales</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
                    <span class="n">y_fitted</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">y_fitted</span>
                    <span class="n">left_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\log_</span><span class="si">{10}</span><span class="s1">y=$&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">left_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$y=$&#39;</span>
                    
                <span class="n">end_label</span> <span class="o">=</span>  <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$+$&#39;</span> <span class="k">if</span> <span class="n">intercept</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">intercept</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;$r\approx$&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">r_value</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;$\ \ p\geqslant$&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">p_value</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span>
                
                <span class="n">_log_or_linear_plot</span><span class="p">(</span><span class="n">scales</span><span class="p">,</span> <span class="n">axes</span><span class="p">)(</span><span class="n">x_fitted</span><span class="p">,</span> <span class="n">y_fitted</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">left_label</span><span class="o">+</span><span class="n">right_label</span><span class="o">+</span><span class="n">end_label</span><span class="p">,</span> <span class="o">**</span><span class="n">fit_line_plot_kwargs</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">mean_std</span><span class="p">:</span>
                <span class="n">unlog_x_mean</span><span class="p">,</span> <span class="n">x_cap</span><span class="p">,</span> <span class="n">x_label</span> <span class="o">=</span> <span class="n">_mean_std_params</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">scales</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">unlog_y_mean</span><span class="p">,</span> <span class="n">y_cap</span><span class="p">,</span> <span class="n">y_label</span> <span class="o">=</span> <span class="n">_mean_std_params</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">scales</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    
                <span class="n">axes</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">unlog_x_mean</span><span class="p">,</span> <span class="n">unlog_y_mean</span><span class="p">,</span> <span class="n">xerr</span><span class="o">=</span><span class="n">x_cap</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">y_cap</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">x_label</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">y_label</span><span class="p">,</span> <span class="o">**</span><span class="n">mean_std_errorbar_kwargs</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mean_std_line</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">separate</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
                    <span class="n">unlog_y_means</span><span class="p">,</span> <span class="n">y_caps</span> <span class="o">=</span> <span class="n">_mean_std_line_params</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x_edges</span><span class="p">,</span> <span class="n">scales</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">axes</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x_mid</span><span class="p">,</span> <span class="n">unlog_y_means</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">y_caps</span><span class="p">,</span> <span class="o">**</span><span class="n">mean_std_line_kwargs</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">separate</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                    <span class="n">unlog_x_means</span><span class="p">,</span> <span class="n">x_caps</span> <span class="o">=</span> <span class="n">_mean_std_line_params</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y_edges</span><span class="p">,</span> <span class="n">scales</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">axes</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">unlog_x_means</span><span class="p">,</span> <span class="n">y_mid</span><span class="p">,</span> <span class="n">xerr</span><span class="o">=</span><span class="n">x_caps</span><span class="p">,</span> <span class="o">**</span><span class="n">mean_std_line_kwargs</span><span class="p">)</span>
                    
    
        
    <span class="k">if</span> <span class="n">scales</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">scales</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">quadmesh</span></div>



<span class="k">def</span> <span class="nf">_auto_downsample</span><span class="p">(</span><span class="n">axes</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">|</span><span class="nb">list</span><span class="o">|</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">|</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">,</span> <span class="n">max_dens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Downsamples the data points to ensure the density of points on the plot does not exceed a specified maximum density.</span>

<span class="sd">    :param axes: The matplotlib axes object where the data will be plotted.</span>
<span class="sd">    :param x: The x-coordinates of the data points. Can be a list of datetime objects.</span>
<span class="sd">    :param y: The y-coordinates of the data points.</span>
<span class="sd">    :param max_dens: The maximum allowed number of points per inch on the plot.</span>
<span class="sd">    </span>
<span class="sd">    :return x: The downsampled x (preserves original datetime type if applicable).</span>
<span class="sd">    :return y: The downsampled y.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">examine_size</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># axes_width / examine_size</span>

    <span class="c1"># Convert x to numpy array and handle datetime types</span>
    <span class="n">x_original</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">x_num</span> <span class="o">=</span> <span class="n">x_original</span>  <span class="c1"># Initialize numerical x for histogram</span>

    <span class="c1"># Handle datetime conversion to numerical values</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x_original</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">x_original</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">):</span>
        <span class="n">x_num</span> <span class="o">=</span> <span class="n">x_original</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x_original</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">x_original</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="nb">object</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_original</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x_original</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">datetime</span><span class="p">):</span>
            <span class="n">x_num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dt</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">x_original</span><span class="o">.</span><span class="n">ravel</span><span class="p">()])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x_original</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="c1"># Handle Quantity types</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x_original</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">):</span>
        <span class="n">x_num</span> <span class="o">=</span> <span class="n">x_original</span><span class="o">.</span><span class="n">value</span>

    <span class="c1"># Mask NaN values based on y</span>
    <span class="n">nan_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">y_nan</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">nan_mask</span><span class="p">]</span>
    <span class="n">y_non_nan</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="o">~</span><span class="n">nan_mask</span><span class="p">]</span>
    <span class="n">x_non_nan_original</span> <span class="o">=</span> <span class="n">x_original</span><span class="p">[</span><span class="o">~</span><span class="n">nan_mask</span><span class="p">]</span>
    <span class="n">x_non_nan_num</span> <span class="o">=</span> <span class="n">x_num</span><span class="p">[</span><span class="o">~</span><span class="n">nan_mask</span><span class="p">]</span>

    <span class="c1"># Calculate histogram bins based on numerical x values</span>
    <span class="n">axes_width</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">axes</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">get_size_inches</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">hists</span><span class="p">,</span> <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">x_non_nan_num</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">axes_width</span><span class="p">)</span><span class="o">*</span><span class="n">examine_size</span><span class="p">)</span>
    <span class="n">high_density_bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">hists</span> <span class="o">&gt;</span> <span class="n">max_dens</span><span class="o">/</span><span class="n">examine_size</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">high_density_bins</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x_original</span><span class="p">,</span> <span class="n">y</span>

    <span class="n">low_density_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_non_nan_num</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">downsampled_indices</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Downsample high-density bins</span>
    <span class="k">for</span> <span class="n">bin_index</span> <span class="ow">in</span> <span class="n">high_density_bins</span><span class="p">:</span>
        <span class="n">bin_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_non_nan_num</span> <span class="o">&gt;=</span> <span class="n">bin_edges</span><span class="p">[</span><span class="n">bin_index</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x_non_nan_num</span> <span class="o">&lt;</span> <span class="n">bin_edges</span><span class="p">[</span><span class="n">bin_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">bin_mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">low_density_mask</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">num_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_dens</span><span class="o">/</span><span class="n">examine_size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_samples</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">num_samples</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">downsampled_indices</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">num_samples</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">))</span>

    <span class="c1"># Combine indices and sort</span>
    <span class="n">non_nan_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">low_density_mask</span><span class="p">),</span> <span class="n">downsampled_indices</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">non_nan_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">non_nan_indices</span><span class="p">)</span>

    <span class="c1"># Reconstruct final arrays preserving original types</span>
    <span class="n">final_x_unsorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">x_non_nan_original</span><span class="p">[</span><span class="n">non_nan_indices</span><span class="p">],</span> <span class="n">x_original</span><span class="p">[</span><span class="n">nan_mask</span><span class="p">]])</span>
    <span class="n">final_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">final_x_unsorted</span><span class="p">)</span>
    <span class="n">final_x</span> <span class="o">=</span> <span class="n">final_x_unsorted</span><span class="p">[</span><span class="n">final_indices</span><span class="p">]</span>
    <span class="n">final_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">y_non_nan</span><span class="p">[</span><span class="n">non_nan_indices</span><span class="p">],</span> <span class="n">y_nan</span><span class="p">])[</span><span class="n">final_indices</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">final_x</span><span class="p">,</span> <span class="n">final_y</span>


<div class="viewcode-block" id="plot">
<a class="viewcode-back" href="../../../source/spcphys_common_functions.processing.html#spcphys_common_functions.processing.plot_tools.plot">[docs]</a>
<span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">|</span><span class="nb">list</span><span class="o">|</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">|</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">,</span> <span class="n">axes</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="o">|</span><span class="kc">None</span> <span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">auto_downsample</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_dens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Plot x and y data.</span>
<span class="sd">    </span>
<span class="sd">    :param x: The x-axis data.</span>
<span class="sd">    :param y: The y-axis data.</span>
<span class="sd">    :param axes: The matplotlib axes to plot on. Default is None.</span>
<span class="sd">    :param scale: The scale for the plot, can be &#39;linear&#39; or &#39;log&#39;. Default is &#39;linear&#39;.</span>
<span class="sd">    :param auto_downsample: Whether to automatically downsample the data. Default is True.</span>
<span class="sd">    :param max_dens: The maximum number of data points per inch. Default is 1000.</span>
<span class="sd">    :param plot_kwargs: Additional arguments for the plot function.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">if</span> <span class="n">axes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span>
    
    <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
        <span class="n">plot_func</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">semilogy</span>
    <span class="k">elif</span> <span class="n">scale</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
        <span class="n">plot_func</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span>
    
    <span class="k">if</span> <span class="n">auto_downsample</span><span class="p">:</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">_auto_downsample</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">max_dens</span><span class="p">)</span>
        
    <span class="n">plot_func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">)</span></div>




<div class="viewcode-block" id="plot_mesh1d_ts">
<a class="viewcode-back" href="../../../source/spcphys_common_functions.processing.html#spcphys_common_functions.processing.plot_tools.plot_mesh1d_ts">[docs]</a>
<span class="k">def</span> <span class="nf">plot_mesh1d_ts</span><span class="p">(</span><span class="n">axes</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">|</span><span class="n">List</span><span class="p">[</span><span class="n">datetime</span><span class="p">],</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">|</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="o">|</span><span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">|</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">],</span> <span class="n">z</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">|</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="o">|</span><span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">|</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">],</span>
                   <span class="n">width</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span><span class="o">|</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">|</span><span class="n">timedelta</span><span class="o">|</span><span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">norm</span><span class="p">:</span> <span class="nb">str</span><span class="o">|</span><span class="n">LogNorm</span><span class="o">|</span><span class="n">Normalize</span> <span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">pcolormesh_kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QuadMesh</span><span class="p">:</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Plot a 1D mesh plot with time as the x-axis.</span>
<span class="sd">    </span>
<span class="sd">    :param axes: The matplotlib axes to plot on.</span>
<span class="sd">    :param t: The time data.</span>
<span class="sd">    :param y: The y-axis data in shape (t, y) or (y,). Can be a list if length of y varies with time.</span>
<span class="sd">    :param z: The z-axis data in shape (t, y). Can be a list if length of y varies with time.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">INVALID_DIFF_PERCENT</span> <span class="o">=</span> <span class="mf">0.1</span>
    
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">t</span>
    
    <span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">t_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">t_diff_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">t_diff</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">t_diff</span> <span class="o">&lt;</span> <span class="n">t_diff_mean</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">INVALID_DIFF_PERCENT</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">t_diff</span> <span class="o">&gt;</span> <span class="n">t_diff_mean</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">INVALID_DIFF_PERCENT</span><span class="p">)):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The time intervals are not equal.&quot;</span><span class="p">)</span>
            
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">width</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The width must have the same length as t - 1.&quot;</span><span class="p">)</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">width</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>
            
    <span class="k">if</span> <span class="n">norm</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">z</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">norm</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">z</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">z</span><span class="p">))</span>
            
    <span class="k">if</span> <span class="s1">&#39;norm&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pcolormesh_kwargs</span><span class="p">:</span>
        <span class="n">pcolormesh_kwargs</span><span class="p">[</span><span class="s1">&#39;norm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm</span>
            
    <span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">yi_valid_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">yi_valid_indices</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">quadmesh</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">([</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">yi_valid_indices</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(([</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">yi_valid_indices</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">yi_valid_indices</span><span class="p">]]))</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="o">**</span><span class="n">pcolormesh_kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">yi_valid_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">yi_valid_indices</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">quadmesh</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">([</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">width</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">yi_valid_indices</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(([</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">yi_valid_indices</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">yi_valid_indices</span><span class="p">]]))</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="o">**</span><span class="n">pcolormesh_kwargs</span><span class="p">)</span>
            
    <span class="k">return</span> <span class="n">quadmesh</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, NyankoSong.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>