

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>spcphys_common_functions.processing.plot_tools &mdash; spcphys_common_functions  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            spcphys_common_functions
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../source/spcphys_common_functions.html">spcphys_common_functions package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">spcphys_common_functions</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">spcphys_common_functions.processing.plot_tools</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for spcphys_common_functions.processing.plot_tools</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;Module for plotting tools.&#39;&#39;&#39;</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Literal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy</span><span class="w"> </span><span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy</span><span class="w"> </span><span class="kn">import</span> <span class="n">stats</span> <span class="k">as</span> <span class="n">astats</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="kn">import</span> <span class="n">LogNorm</span><span class="p">,</span> <span class="n">Normalize</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">QuadMesh</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.contour</span><span class="w"> </span><span class="kn">import</span> <span class="n">QuadContourSet</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">stats</span>




<span class="k">def</span><span class="w"> </span><span class="nf">_determine_bins</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">scale</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">astats</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">scale</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Logarithmic scale requires all x values to be positive.&quot;</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">astats</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
        <span class="n">bins</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">bins</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;scale must be &#39;linear&#39; or &#39;log&#39;&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bins</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_log_or_linear_plot</span><span class="p">(</span><span class="n">scales</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">ax</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    
    <span class="k">if</span> <span class="n">scales</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span> <span class="ow">and</span> <span class="n">scales</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">plt</span><span class="o">.</span><span class="n">loglog</span> <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ax</span><span class="o">.</span><span class="n">loglog</span>
    <span class="k">elif</span> <span class="n">scales</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span> <span class="ow">and</span> <span class="n">scales</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">plt</span><span class="o">.</span><span class="n">semilogx</span> <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ax</span><span class="o">.</span><span class="n">semilogx</span>
    <span class="k">elif</span> <span class="n">scales</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span> <span class="ow">and</span> <span class="n">scales</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">plt</span><span class="o">.</span><span class="n">semilogy</span> <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ax</span><span class="o">.</span><span class="n">semilogy</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span> <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_logarithmic_error</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mean_func</span><span class="p">):</span>
    <span class="n">log_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">log_x_mean</span> <span class="o">=</span> <span class="n">mean_func</span><span class="p">(</span><span class="n">log_x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">unlog_x_mean</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">log_x_mean</span>
    <span class="n">log_x_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">log_x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># This method is not used in this way, but is used for observational data without raw data,</span>
    <span class="c1"># such as when only the mean and standard deviation are provided</span>
    <span class="n">x_cap</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">unlog_x_mean</span> <span class="o">-</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">log_x_mean</span> <span class="o">-</span> <span class="n">log_x_std</span><span class="p">)),</span>  <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">unlog_x_mean</span> <span class="o">-</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">log_x_mean</span> <span class="o">+</span> <span class="n">log_x_std</span><span class="p">))]</span>
    <span class="k">return</span> <span class="n">unlog_x_mean</span><span class="p">,</span> <span class="n">log_x_std</span><span class="p">,</span> <span class="n">x_cap</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_mean_std_params</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">scale</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
        <span class="n">unlog_x_mean</span><span class="p">,</span> <span class="n">log_x_std</span><span class="p">,</span> <span class="n">x_cap</span> <span class="o">=</span> <span class="n">_logarithmic_error</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">x_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$x=10\^($&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">unlog_x_mean</span><span class="p">)</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;$\pm$&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">log_x_std</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;$)$&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x_mean</span><span class="p">,</span> <span class="n">x_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">x_cap</span> <span class="o">=</span> <span class="p">[</span><span class="n">x_err</span><span class="p">,</span> <span class="n">x_err</span><span class="p">]</span>
        <span class="n">x_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$x=$&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x_mean</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;$\pm$&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">x_err</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="k">return</span> <span class="n">unlog_x_mean</span><span class="p">,</span> <span class="n">x_cap</span><span class="p">,</span> <span class="n">x_label</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_mean_std_line_params</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x_edges</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">method</span><span class="p">):</span>
    <span class="n">unlog_y_means</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">y_caps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
        <span class="n">mean_func</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
        <span class="n">mean_func</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;median&#39;</span><span class="p">:</span>
        <span class="n">mean_func</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span>
    <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_edges</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">unlog_y_mean</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">y_cap</span> <span class="o">=</span> <span class="n">_logarithmic_error</span><span class="p">(</span><span class="n">y</span><span class="p">[(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">x_edges</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">x_edges</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])],</span> <span class="n">mean_func</span><span class="p">)</span>
            <span class="n">unlog_y_means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unlog_y_mean</span><span class="p">)</span>
            <span class="n">y_caps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_cap</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_edges</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">y_window</span> <span class="o">=</span> <span class="n">y</span><span class="p">[(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">x_edges</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="n">x_edges</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])]</span>
            <span class="n">y_mean</span><span class="p">,</span> <span class="n">y_err</span> <span class="o">=</span> <span class="n">mean_func</span><span class="p">(</span><span class="n">y_window</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">y_window</span><span class="p">)</span>
            <span class="n">unlog_y_means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y_mean</span><span class="p">)</span>
            <span class="n">y_caps</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">y_err</span><span class="p">,</span> <span class="n">y_err</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">unlog_y_means</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y_caps</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>


<span class="c1"># def plot_hist2d(</span>
<span class="c1">#     axes: plt.Axes, x: np.ndarray|u.Quantity, y: np.ndarray|u.Quantity, z: np.ndarray|u.Quantity|None=None, least_samples_per_cell: int=1, </span>
<span class="c1">#     scales: list|tuple|str=&#39;linear&#39;, norm_type: Literal[&#39;sum&#39;, &#39;max&#39;, None]=None,</span>
<span class="c1">#     color_norm_type: str=&#39;linear&#39;, color_norm_range: list|tuple|None=None, bins: int|np.ndarray|list|str=&#39;freedman&#39;, hist_pcolormesh_kwargs: dict|None=None,</span>
<span class="c1">#     contour_only: bool=False, contour_smooth: int|float|None=None, contour_kwargs: dict|None=None,</span>
<span class="c1">#     fit_line: bool=False, fit_line_kwargs: dict|None=None,</span>
<span class="c1">#     mean_std: bool=False, mean_std_errorbar_kwargs: dict|None=None,</span>
<span class="c1">#     separate: str|None=None,</span>
<span class="c1">#     mean_std_line: Literal[&#39;x&#39;, &#39;y&#39;, None] =None, mean_std_line_method: Literal[&#39;mean&#39;, &#39;max&#39;, &#39;median&#39;] =&#39;mean&#39;, mean_std_line_kwargs: dict|None=None,</span>
<span class="c1"># ) -&gt; QuadMesh | QuadContourSet:</span>
    
<span class="c1">#     &#39;&#39;&#39;</span>
<span class="c1">#     Plot a 2D histogram. If z is provided, overplot z as color.</span>

<span class="c1">#     :param axes: The matplotlib axes to plot on.</span>
<span class="c1">#     :param x: The x-axis data, can be a numpy array or an astropy Quantity.</span>
<span class="c1">#     :param y: The y-axis data, can be a numpy array or an astropy Quantity.</span>
<span class="c1">#     :param z: The z-axis data, can be a numpy array or an astropy Quantity. Default is None.</span>
<span class="c1">#     :param least_samples_per_cell: The least number of samples per cell to plot, valid only when z is not None. Default is 0.</span>
<span class="c1">#     :param scales: The scales for the axes, can be &#39;linear&#39; or &#39;log&#39;. Default is &#39;linear&#39;.</span>
<span class="c1">#     :param norm_type: The normalization type, can be &#39;max&#39;, &#39;sum&#39;, or None. Default is None.</span>
<span class="c1">#     :param color_norm_type: The color normalization type, can be &#39;linear&#39; or &#39;log&#39;. Default is &#39;linear&#39;.</span>
<span class="c1">#     :param color_norm_range: The range for color normalization. Default is None.</span>
<span class="c1">#     :param bins: The bins for the histogram, can be an integer, numpy array, list, or a string (&#39;freedman&#39;, &#39;scott&#39;, &#39;knuth&#39;, &#39;blocks&#39;). Default is &#39;freedman&#39;.</span>
<span class="c1">#     :param hist_pcolormesh_kwargs: Additional arguments for pcolormesh. Default is {&#39;cmap&#39;:&#39;jet&#39;}.</span>
<span class="c1">#     :param contour_levels: The levels for contour plotting. Default is None.</span>
<span class="c1">#     :param contour_smooth: The smoothing parameter for contours. Default is None.</span>
<span class="c1">#     :param contour_kwargs: Additional arguments for contour plotting. Default is {}.</span>
<span class="c1">#     :param fit_line: Whether to fit a line to the data. Default is False.</span>
<span class="c1">#     :param fit_line_kwargs: Arguments for plotting the fit line. Default is {&#39;c&#39;:&#39;k&#39;, &#39;ls&#39;:&#39;--&#39;, &#39;lw&#39;:1}.</span>
<span class="c1">#     :param mean_std: Whether to plot mean and standard deviation. Default is False.</span>
<span class="c1">#     :param mean_std_errorbar_kwargs: Arguments for plotting error bars of mean and standard deviation. Default is {&#39;fmt&#39;:&#39;none&#39;, &#39;c&#39;:&#39;k&#39;, &#39;capsize&#39;:2}.</span>
<span class="c1">#     :param separate: Whether to normalize separately along &#39;x&#39; or &#39;y&#39; axis. Default is None.</span>
<span class="c1">#     :param mean_std_line: Whether to plot mean and standard deviation line. Can be &#39;x&#39;, &#39;y&#39;, or False. Default is False.</span>
<span class="c1">#     :param mean_std_line_method: The method for calculating the mean and standard deviation line, can be &#39;mean&#39;, &#39;max&#39;, or &#39;median&#39;. Default is &#39;mean&#39;.</span>
<span class="c1">#     :param mean_std_line_kwargs: Arguments for plotting the mean and standard deviation line. Default is {&#39;fmt&#39;:&#39;o&#39;, &#39;ms&#39;:2, &#39;c&#39;:&#39;k&#39;, &#39;capsize&#39;:2, &#39;lw&#39;:1, &#39;ls&#39;:&#39;-&#39;}.</span>
    
<span class="c1">#     :return quadmesh: The QuadMesh object of the 2D histogram.</span>
<span class="c1">#     &#39;&#39;&#39;</span>
    
<span class="c1">#     if least_samples_per_cell &lt; 1:</span>
<span class="c1">#         raise ValueError(&quot;least_samples_per_cell must be a positive integer.&quot;)</span>
<span class="c1">#     if norm_type and norm_type not in [&#39;max&#39;, &#39;sum&#39;]:</span>
<span class="c1">#         raise ValueError(&quot;norm_type must be &#39;max&#39;, &#39;sum&#39; or None.&quot;)</span>
<span class="c1">#     if color_norm_type not in [&#39;log&#39;, &#39;linear&#39;]:</span>
<span class="c1">#         raise ValueError(&quot;color_norm_type must be &#39;log&#39; or &#39;linear&#39;.&quot;)</span>
<span class="c1">#     if isinstance(bins, str) and bins not in [&#39;freedman&#39;, &#39;scott&#39;, &#39;knuth&#39;, &#39;blocks&#39;]:</span>
<span class="c1">#         raise ValueError(&quot;bins must be &#39;freedman&#39;, &#39;scott&#39;, &#39;knuth&#39;, &#39;blocks&#39;, an integer, a numpy array, or a list.&quot;)</span>
<span class="c1">#     if separate and separate not in [&#39;x&#39;, &#39;y&#39;]:</span>
<span class="c1">#         raise ValueError(&quot;separate must be &#39;x&#39;, &#39;y&#39; or None.&quot;)</span>
<span class="c1">#     if separate and z is not None:</span>
<span class="c1">#         raise ValueError(&quot;separate cannot be used when z is provided.&quot;)</span>
<span class="c1">#     if contour_only and z is not None:</span>
<span class="c1">#         raise ValueError(&quot;contour_only cannot be True when z is provided.&quot;)</span>
<span class="c1">#     if norm_type is not None and z is not None:</span>
<span class="c1">#         raise ValueError(&quot;norm_type cannot be used when z is provided.&quot;)</span>
        
<span class="c1">#     if hist_pcolormesh_kwargs is None:</span>
<span class="c1">#         hist_pcolormesh_kwargs = {}</span>
<span class="c1">#     hist_pcolormesh_kwargs.setdefault(&#39;cmap&#39;, &#39;jet&#39;)</span>
    
<span class="c1">#     if contour_kwargs is None:</span>
<span class="c1">#         contour_kwargs = {}</span>
        
<span class="c1">#     if fit_line_kwargs is None:</span>
<span class="c1">#         fit_line_kwargs = {}</span>
<span class="c1">#     fit_line_kwargs.setdefault(&#39;c&#39;, &#39;k&#39;)</span>
<span class="c1">#     fit_line_kwargs.setdefault(&#39;ls&#39;, &#39;--&#39;)</span>
<span class="c1">#     fit_line_kwargs.setdefault(&#39;lw&#39;, 1)</span>
        
<span class="c1">#     if mean_std_errorbar_kwargs is None:</span>
<span class="c1">#         mean_std_errorbar_kwargs = {}</span>
<span class="c1">#     mean_std_errorbar_kwargs.setdefault(&#39;fmt&#39;, &#39;none&#39;)</span>
<span class="c1">#     mean_std_errorbar_kwargs.setdefault(&#39;c&#39;, &#39;k&#39;)</span>
<span class="c1">#     mean_std_errorbar_kwargs.setdefault(&#39;capsize&#39;, 2)</span>
        
<span class="c1">#     if mean_std_line_kwargs is None:</span>
<span class="c1">#         mean_std_line_kwargs = {}</span>
<span class="c1">#     mean_std_line_kwargs.setdefault(&#39;fmt&#39;, &#39;o&#39;)</span>
<span class="c1">#     mean_std_line_kwargs.setdefault(&#39;ms&#39;, 2)</span>
<span class="c1">#     mean_std_line_kwargs.setdefault(&#39;c&#39;, &#39;k&#39;)</span>
<span class="c1">#     mean_std_line_kwargs.setdefault(&#39;capsize&#39;, 2)</span>
<span class="c1">#     mean_std_line_kwargs.setdefault(&#39;lw&#39;, 1)</span>
<span class="c1">#     mean_std_line_kwargs.setdefault(&#39;ls&#39;, &#39;-&#39;)</span>
        

<span class="c1">#     if isinstance(x, u.Quantity):</span>
<span class="c1">#         x = x.value</span>
<span class="c1">#     if isinstance(y, u.Quantity):</span>
<span class="c1">#         y = y.value</span>
    
    
<span class="c1">#     bins = [bins, bins] if isinstance(bins, str|int) else bins</span>
<span class="c1">#     scales = [scales, scales] if isinstance(scales, str) and z is None else [scales, scales, scales] if isinstance(scales, str) else scales</span>
    
<span class="c1">#     bins_x = _determine_bins(x, bins[0], scales[0])</span>
<span class="c1">#     bins_y = _determine_bins(y, bins[1], scales[1])</span>
    
<span class="c1">#     z_hist, x_edges, y_edges = np.histogram2d(x, y, bins=[bins_x, bins_y])</span>
<span class="c1">#     if len(z_hist.shape) &lt; 2:</span>
<span class="c1">#         raise ValueError(&quot;No enough data to plot 2D histogram.&quot;)</span>
        
<span class="c1">#     x_mid = (x_edges[1:] + x_edges[:-1]) / 2</span>
<span class="c1">#     y_mid = (y_edges[1:] + y_edges[:-1]) / 2</span>
    
<span class="c1">#     if z is not None:</span>
<span class="c1">#         z_scaled = np.log10(z) if scales[2] == &#39;log&#39; else z</span>
<span class="c1">#         z_mat = np.full(z_hist.shape, np.nan)</span>
<span class="c1">#         for j in range(len(x_edges) - 1):</span>
<span class="c1">#             for k in range(len(y_edges) - 1):</span>
<span class="c1">#                 z_jk = z_scaled[(x &gt; x_edges[j]) &amp; (x &lt;= x_edges[j + 1]) &amp; (y &gt; y_edges[k]) &amp; (y &lt;= y_edges[k + 1])]</span>
<span class="c1">#                 z_mat[j, k] = np.nanmean(z_jk) if len(z_jk) &gt;= least_samples_per_cell else np.nan</span>
<span class="c1">#         z_mat = 10**z_mat if scales[2] == &#39;log&#39; else z_mat</span>
        
<span class="c1">#         if scales[2] == &#39;log&#39;:</span>
<span class="c1">#             color_norm = LogNorm(*color_norm_range) if color_norm_range else LogNorm(vmin=np.nanmin(z_mat), vmax=np.nanmax(z_mat))</span>
<span class="c1">#         elif scales[2] == &#39;linear&#39;:</span>
<span class="c1">#             color_norm = Normalize(*color_norm_range) if color_norm_range else Normalize(vmin=np.nanmin(z_mat), vmax=np.nanmax(z_mat))</span>
        
<span class="c1">#         if contour_only:</span>
<span class="c1">#             raise ValueError(&quot;contour_only cannot be True when z is provided.&quot;)</span>
<span class="c1">#         else:</span>
<span class="c1">#             quadmesh = axes.pcolormesh(x_edges, y_edges, z_mat.T, norm=color_norm, **hist_pcolormesh_kwargs)</span>
        
<span class="c1">#     else:</span>
<span class="c1">#         if norm_type == &#39;max&#39;:</span>
<span class="c1">#             if separate == &#39;x&#39;:</span>
<span class="c1">#                 z_hist /= np.nanmax(z_hist, axis=1, keepdims=True)</span>
<span class="c1">#             elif separate == &#39;y&#39;:</span>
<span class="c1">#                 z_hist /= np.nanmax(z_hist, axis=0, keepdims=True)</span>
<span class="c1">#             else:</span>
<span class="c1">#                 z_hist /= np.nanmax(z_hist)</span>
<span class="c1">#         elif norm_type == &#39;sum&#39;:</span>
<span class="c1">#             if separate == &#39;x&#39;:</span>
<span class="c1">#                 z_hist /= np.nansum(z_hist, axis=1, keepdims=True)</span>
<span class="c1">#             elif separate == &#39;y&#39;:</span>
<span class="c1">#                 z_hist /= np.nansum(z_hist, axis=0, keepdims=True)</span>
<span class="c1">#             else:</span>
<span class="c1">#                 z_hist /= np.nansum(z_hist)</span>
        
<span class="c1">#         if color_norm_type == &#39;log&#39;:</span>
<span class="c1">#             color_norm = LogNorm(*color_norm_range) if color_norm_range else LogNorm(vmin=np.nanmin(z_hist[z_hist &gt; 0]), vmax=np.nanmax(z_hist))</span>
<span class="c1">#             lower_level, upper_level = np.ceil(np.log10(np.nanmin(z_hist[z_hist &gt; 0]))), np.floor(np.log10(np.nanmax(z_hist)))</span>
<span class="c1">#             contour_levels_gen = 10**np.arange(lower_level, upper_level + 1)</span>
<span class="c1">#         elif color_norm_type == &#39;linear&#39;:</span>
<span class="c1">#             color_norm = Normalize(*color_norm_range) if color_norm_range else Normalize(vmin=np.nanmin(z_hist), vmax=np.nanmax(z_hist))</span>
<span class="c1">#             lower_level, upper_level = np.nanmin(z_hist), np.nanmax(z_hist)</span>
<span class="c1">#             contour_levels_gen = np.linspace(lower_level, upper_level, 5)</span>
        
<span class="c1">#         z_masked = np.ma.masked_where(z_hist == 0, z_hist)</span>
<span class="c1">#         if not contour_only:</span>
<span class="c1">#             quadmesh = axes.pcolormesh(x_edges, y_edges, z_masked.T, norm=color_norm, **hist_pcolormesh_kwargs)</span>
    
<span class="c1">#         if not separate:</span>
<span class="c1">#             if len(contour_kwargs) &gt; 0 or contour_only:</span>
<span class="c1">#                 if &#39;levels&#39; not in contour_kwargs:</span>
<span class="c1">#                     contour_kwargs[&#39;levels&#39;] = contour_levels_gen</span>
<span class="c1">#                 if contour_smooth:</span>
<span class="c1">#                     if isinstance(contour_smooth, int) or int(contour_smooth) == contour_smooth:</span>
<span class="c1">#                         z_hist = convolve2d(z_hist, np.ones((contour_smooth, contour_smooth)), mode=&#39;same&#39;)</span>
<span class="c1">#                     elif isinstance(contour_smooth, float):</span>
<span class="c1">#                         z_hist = convolve2d(z_hist, np.ones((int(contour_smooth*z_hist.shape[0]), int(contour_smooth*z_hist.shape[1]))), mode=&#39;same&#39;)</span>
<span class="c1">#                 quadcontourset = axes.contour(x_mid, y_mid, z_hist.T, norm=color_norm, **contour_kwargs)</span>
            
<span class="c1">#         if fit_line:</span>
<span class="c1">#             if scales[0] == &#39;log&#39;:</span>
<span class="c1">#                 x_fit = np.log10(x)</span>
<span class="c1">#             else:</span>
<span class="c1">#                 x_fit = x</span>
<span class="c1">#             if scales[1] == &#39;log&#39;:</span>
<span class="c1">#                 y_fit = np.log10(y)</span>
<span class="c1">#             else:</span>
<span class="c1">#                 y_fit = y</span>
                
<span class="c1">#             slope, intercept, r_value, p_value, _ = stats.linregress(x_fit, y_fit)</span>
<span class="c1">#             x_fitted = np.array([np.nanmin(x_fit), np.nanmax(x_fit)])</span>
<span class="c1">#             y_fitted = slope * x_fitted + intercept</span>
            
<span class="c1">#             if scales[0] == &#39;log&#39;:</span>
<span class="c1">#                 x_fitted = 10**x_fitted</span>
<span class="c1">#                 right_label = f&#39;{slope:.2f}&#39; + r&#39;$\log_{10}x$&#39;</span>
<span class="c1">#             else:</span>
<span class="c1">#                 right_label = f&#39;{slope:.2f}&#39; + r&#39;$x$&#39;</span>
<span class="c1">#             if scales[1] == &#39;log&#39;:</span>
<span class="c1">#                 y_fitted = 10**y_fitted</span>
<span class="c1">#                 left_label = r&#39;$\log_{10}y=$&#39;</span>
<span class="c1">#             else:</span>
<span class="c1">#                 left_label = r&#39;$y=$&#39;</span>
                
<span class="c1">#             # end_label =  (r&#39;$+$&#39; if intercept &gt; 0 else &#39;&#39;) + f&#39;{intercept:.2f}\n&#39; + r&#39;$r\approx$&#39; + f&#39;{r_value:.2f}&#39; + r&#39;$\ \ p\geqslant$&#39; + f&#39;{p_value:.2f}&#39;</span>
<span class="c1">#             end_label =  (r&#39;$+$&#39; if intercept &gt; 0 else &#39;&#39;) + f&#39;{intercept:.2f}\n&#39; + r&#39;$r\approx$&#39; + f&#39;{r_value:.2f}&#39; + r&#39;$\ \ p\leqslant$&#39; + f&#39;{p_value + 0.01 if p_value &gt;= 0.01 else 0.01:.2f}&#39;</span>
<span class="c1">#             fit_line_kwargs.setdefault(&#39;label&#39;, left_label+right_label+end_label)</span>
            
<span class="c1">#             _log_or_linear_plot(scales, axes)(x_fitted, y_fitted, **fit_line_kwargs)</span>
            
<span class="c1">#         if mean_std:</span>
<span class="c1">#             unlog_x_mean, x_cap, x_label = _mean_std_params(x, scales[0])</span>
<span class="c1">#             unlog_y_mean, y_cap, y_label = _mean_std_params(y, scales[1])</span>
                
<span class="c1">#             axes.errorbar(unlog_x_mean, unlog_y_mean, xerr=x_cap, yerr=y_cap, label=x_label+&#39;\n&#39;+y_label, **mean_std_errorbar_kwargs)</span>
            
<span class="c1">#         if mean_std_line:</span>
<span class="c1">#             if separate == &#39;x&#39; or mean_std_line == &#39;x&#39;:</span>
<span class="c1">#                 unlog_y_means, y_caps = _mean_std_line_params(x, y, x_edges, scales[1], method=mean_std_line_method)</span>
<span class="c1">#                 axes.errorbar(x_mid, unlog_y_means, yerr=y_caps, **mean_std_line_kwargs)</span>
<span class="c1">#             elif separate == &#39;y&#39; or mean_std_line == &#39;y&#39;:</span>
<span class="c1">#                 unlog_x_means, x_caps = _mean_std_line_params(y, x, y_edges, scales[0], method=mean_std_line_method)</span>
<span class="c1">#                 axes.errorbar(unlog_x_means, y_mid, xerr=x_caps, **mean_std_line_kwargs)</span>
                    
    
        
<span class="c1">#     if scales[0] == &#39;log&#39;:</span>
<span class="c1">#         axes.set_xscale(&#39;log&#39;)</span>
<span class="c1">#     if scales[1] == &#39;log&#39;:</span>
<span class="c1">#         axes.set_yscale(&#39;log&#39;)</span>
        
<span class="c1">#     if contour_only:</span>
<span class="c1">#         return quadcontourset</span>
<span class="c1">#     else:</span>
<span class="c1">#         return quadmesh</span>
    


<div class="viewcode-block" id="plot_hist2d">
<a class="viewcode-back" href="../../../source/spcphys_common_functions.processing.html#spcphys_common_functions.processing.plot_tools.plot_hist2d">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_hist2d</span><span class="p">(</span>
    <span class="n">axes</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">|</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">|</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">|</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="o">|</span><span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">least_samples_per_cell</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
    <span class="n">scales</span><span class="p">:</span> <span class="nb">list</span><span class="o">|</span><span class="nb">tuple</span><span class="o">|</span><span class="nb">str</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">norm_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">color_norm_type</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">color_norm_range</span><span class="p">:</span> <span class="nb">list</span><span class="o">|</span><span class="nb">tuple</span><span class="o">|</span><span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">bins</span><span class="p">:</span> <span class="nb">int</span><span class="o">|</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">|</span><span class="nb">list</span><span class="o">|</span><span class="nb">str</span><span class="o">=</span><span class="s1">&#39;freedman&#39;</span><span class="p">,</span> 
    <span class="n">plot_method</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;pcolormesh&#39;</span><span class="p">,</span> <span class="s1">&#39;contour&#39;</span><span class="p">,</span> <span class="s1">&#39;contourf&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;pcolormesh&#39;</span><span class="p">,</span>
    <span class="n">plot_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="o">|</span><span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">fit_line</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fit_line_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="o">|</span><span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">mean_std</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mean_std_errorbar_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="o">|</span><span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">separate</span><span class="p">:</span> <span class="nb">str</span><span class="o">|</span><span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">mean_std_line</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mean_std_line_method</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;median&#39;</span><span class="p">]</span> <span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">mean_std_line_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="o">|</span><span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QuadMesh</span> <span class="o">|</span> <span class="n">QuadContourSet</span><span class="p">:</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Plot a 2D histogram. If z is provided, overplot z as color.</span>

<span class="sd">    :param axes: The matplotlib axes to plot on.</span>
<span class="sd">    :param x: The x-axis data, can be a numpy array or an astropy Quantity.</span>
<span class="sd">    :param y: The y-axis data, can be a numpy array or an astropy Quantity.</span>
<span class="sd">    :param z: The z-axis data, can be a numpy array or an astropy Quantity. Default is None.</span>
<span class="sd">    :param least_samples_per_cell: The least number of samples per cell to plot, valid only when z is not None. Default is 1.</span>
<span class="sd">    :param scales: The scales for the axes, can be &#39;linear&#39; or &#39;log&#39;. Default is &#39;linear&#39;.</span>
<span class="sd">    :param norm_type: The normalization type, can be &#39;max&#39;, &#39;sum&#39;, or None. Default is None.</span>
<span class="sd">    :param color_norm_type: The color normalization type, can be &#39;linear&#39; or &#39;log&#39;. Default is &#39;linear&#39;.</span>
<span class="sd">    :param color_norm_range: The range for color normalization. Default is None.</span>
<span class="sd">    :param bins: The bins for the histogram, can be an integer, numpy array, list, or a string (&#39;freedman&#39;, &#39;scott&#39;, &#39;knuth&#39;, &#39;blocks&#39;). Default is &#39;freedman&#39;.</span>
<span class="sd">    :param plot_method: The plotting method (&#39;pcolormesh&#39;, &#39;contour&#39;, or &#39;contourf&#39;). Default is &#39;pcolormesh&#39;.</span>
<span class="sd">    :param plot_kwargs: Additional arguments for the plotting method. Default varies by method.</span>
<span class="sd">    :param fit_line: Whether to fit a line to the data. Default is False.</span>
<span class="sd">    :param fit_line_kwargs: Arguments for plotting the fit line. Default is {&#39;c&#39;:&#39;k&#39;, &#39;ls&#39;:&#39;--&#39;, &#39;lw&#39;:1}.</span>
<span class="sd">    :param mean_std: Whether to plot mean and standard deviation. Default is False.</span>
<span class="sd">    :param mean_std_errorbar_kwargs: Arguments for plotting error bars of mean and standard deviation. Default is {&#39;fmt&#39;:&#39;none&#39;, &#39;c&#39;:&#39;k&#39;, &#39;capsize&#39;:2}.</span>
<span class="sd">    :param separate: Whether to normalize separately along &#39;x&#39; or &#39;y&#39; axis. Default is None.</span>
<span class="sd">    :param mean_std_line: Whether to plot mean and standard deviation line. Can be &#39;x&#39;, &#39;y&#39;, or None. Default is None.</span>
<span class="sd">    :param mean_std_line_method: The method for calculating the mean and standard deviation line, can be &#39;mean&#39;, &#39;max&#39;, or &#39;median&#39;. Default is &#39;mean&#39;.</span>
<span class="sd">    :param mean_std_line_kwargs: Arguments for plotting the mean and standard deviation line. Default is {&#39;fmt&#39;:&#39;o&#39;, &#39;ms&#39;:2, &#39;c&#39;:&#39;k&#39;, &#39;capsize&#39;:2, &#39;lw&#39;:1, &#39;ls&#39;:&#39;-&#39;}.</span>
<span class="sd">    </span>
<span class="sd">    :return: The plot object (QuadMesh or QuadContourSet).</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="c1"># Validation</span>
    <span class="k">if</span> <span class="n">least_samples_per_cell</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;least_samples_per_cell must be a positive integer.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">norm_type</span> <span class="ow">and</span> <span class="n">norm_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;norm_type must be &#39;max&#39;, &#39;sum&#39; or None.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">color_norm_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="s1">&#39;linear&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;color_norm_type must be &#39;log&#39; or &#39;linear&#39;.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">bins</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;freedman&#39;</span><span class="p">,</span> <span class="s1">&#39;scott&#39;</span><span class="p">,</span> <span class="s1">&#39;knuth&#39;</span><span class="p">,</span> <span class="s1">&#39;blocks&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;bins must be &#39;freedman&#39;, &#39;scott&#39;, &#39;knuth&#39;, &#39;blocks&#39;, an integer, a numpy array, or a list.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">separate</span> <span class="ow">and</span> <span class="n">separate</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;separate must be &#39;x&#39;, &#39;y&#39; or None.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">separate</span> <span class="ow">and</span> <span class="n">z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;separate cannot be used when z is provided.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">norm_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;norm_type cannot be used when z is provided.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">plot_method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pcolormesh&#39;</span><span class="p">,</span> <span class="s1">&#39;contour&#39;</span><span class="p">,</span> <span class="s1">&#39;contourf&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;plot_method must be &#39;pcolormesh&#39;, &#39;contour&#39;, or &#39;contourf&#39;.&quot;</span><span class="p">)</span>
        
    <span class="c1"># Set default kwargs based on plot method</span>
    <span class="k">if</span> <span class="n">plot_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plot_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">if</span> <span class="n">plot_method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pcolormesh&#39;</span><span class="p">,</span> <span class="s1">&#39;contourf&#39;</span><span class="p">]:</span>
        <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;cmap&#39;</span><span class="p">,</span> <span class="s1">&#39;jet&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">plot_method</span> <span class="o">==</span> <span class="s1">&#39;contour&#39;</span><span class="p">:</span>
        <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;colors&#39;</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>  <span class="c1"># contour默认使用黑色线条</span>
        <span class="c1"># 如果用户指定了cmap，则移除colors</span>
        <span class="k">if</span> <span class="s1">&#39;cmap&#39;</span> <span class="ow">in</span> <span class="n">plot_kwargs</span><span class="p">:</span>
            <span class="n">plot_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;colors&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">fit_line_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fit_line_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">fit_line_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
    <span class="n">fit_line_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;ls&#39;</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">)</span>
    <span class="n">fit_line_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;lw&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mean_std_errorbar_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mean_std_errorbar_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">mean_std_errorbar_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;fmt&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">)</span>
    <span class="n">mean_std_errorbar_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
    <span class="n">mean_std_errorbar_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;capsize&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">mean_std_line_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mean_std_line_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">mean_std_line_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;fmt&#39;</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">)</span>
    <span class="n">mean_std_line_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;ms&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">mean_std_line_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
    <span class="n">mean_std_line_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;capsize&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">mean_std_line_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;lw&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">mean_std_line_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;ls&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>

    <span class="c1"># Convert quantities to values</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">value</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">value</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">):</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">value</span>
    
    <span class="c1"># Handle bins and scales</span>
    <span class="n">bins</span> <span class="o">=</span> <span class="p">[</span><span class="n">bins</span><span class="p">,</span> <span class="n">bins</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span> <span class="nb">str</span><span class="o">|</span><span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">bins</span>
    <span class="n">scales</span> <span class="o">=</span> <span class="p">[</span><span class="n">scales</span><span class="p">,</span> <span class="n">scales</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scales</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">z</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">scales</span><span class="p">,</span> <span class="n">scales</span><span class="p">,</span> <span class="n">scales</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scales</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">scales</span>
    
    <span class="n">bins_x</span> <span class="o">=</span> <span class="n">_determine_bins</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">scales</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">bins_y</span> <span class="o">=</span> <span class="n">_determine_bins</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">scales</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="n">z_hist</span><span class="p">,</span> <span class="n">x_edges</span><span class="p">,</span> <span class="n">y_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram2d</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="n">bins_x</span><span class="p">,</span> <span class="n">bins_y</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">z_hist</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No enough data to plot 2D histogram.&quot;</span><span class="p">)</span>
        
    <span class="n">x_mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">x_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">y_mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">y_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    
    <span class="k">if</span> <span class="n">z</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">z_scaled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="k">if</span> <span class="n">scales</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span> <span class="k">else</span> <span class="n">z</span>
        <span class="n">z_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">z_hist</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_edges</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_edges</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">z_jk</span> <span class="o">=</span> <span class="n">z_scaled</span><span class="p">[(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">x_edges</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="n">x_edges</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">y_edges</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y</span> <span class="o">&lt;=</span> <span class="n">y_edges</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])]</span>
                <span class="n">z_mat</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">z_jk</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">z_jk</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">least_samples_per_cell</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">z_mat</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">z_mat</span> <span class="k">if</span> <span class="n">scales</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span> <span class="k">else</span> <span class="n">z_mat</span>
        
        <span class="k">if</span> <span class="n">scales</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
            <span class="n">color_norm</span> <span class="o">=</span> <span class="n">LogNorm</span><span class="p">(</span><span class="o">*</span><span class="n">color_norm_range</span><span class="p">)</span> <span class="k">if</span> <span class="n">color_norm_range</span> <span class="k">else</span> <span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">z_mat</span><span class="p">),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">z_mat</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">scales</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
            <span class="n">color_norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="o">*</span><span class="n">color_norm_range</span><span class="p">)</span> <span class="k">if</span> <span class="n">color_norm_range</span> <span class="k">else</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">z_mat</span><span class="p">),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">z_mat</span><span class="p">))</span>
        
        <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">z_mat</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">norm_type</span> <span class="o">==</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">separate</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
                <span class="n">z_hist</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">z_hist</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">separate</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="n">z_hist</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">z_hist</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">z_hist</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">z_hist</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">norm_type</span> <span class="o">==</span> <span class="s1">&#39;sum&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">separate</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
                <span class="n">z_hist</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">z_hist</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">separate</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="n">z_hist</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">z_hist</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">z_hist</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">z_hist</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">color_norm_type</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
            <span class="n">valid_data</span> <span class="o">=</span> <span class="n">z_hist</span><span class="p">[</span><span class="n">z_hist</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No valid data for log normalization.&quot;</span><span class="p">)</span>
            <span class="n">color_norm</span> <span class="o">=</span> <span class="n">LogNorm</span><span class="p">(</span><span class="o">*</span><span class="n">color_norm_range</span><span class="p">)</span> <span class="k">if</span> <span class="n">color_norm_range</span> <span class="k">else</span> <span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">valid_data</span><span class="p">),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">valid_data</span><span class="p">))</span>
            <span class="n">lower_level</span><span class="p">,</span> <span class="n">upper_level</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">valid_data</span><span class="p">))),</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">valid_data</span><span class="p">)))</span>
            <span class="n">contour_levels_gen</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lower_level</span><span class="p">,</span> <span class="n">upper_level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">color_norm_type</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
            <span class="n">color_norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="o">*</span><span class="n">color_norm_range</span><span class="p">)</span> <span class="k">if</span> <span class="n">color_norm_range</span> <span class="k">else</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">z_hist</span><span class="p">),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">z_hist</span><span class="p">))</span>
            <span class="n">lower_level</span><span class="p">,</span> <span class="n">upper_level</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">z_hist</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">z_hist</span><span class="p">)</span>
            <span class="n">contour_levels_gen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lower_level</span><span class="p">,</span> <span class="n">upper_level</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        
        <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">z_hist</span>
    
    <span class="c1"># Set default contour levels for contour methods</span>
    <span class="k">if</span> <span class="n">plot_method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;contour&#39;</span><span class="p">,</span> <span class="s1">&#39;contourf&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s1">&#39;levels&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">plot_kwargs</span> <span class="ow">and</span> <span class="n">z</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plot_kwargs</span><span class="p">[</span><span class="s1">&#39;levels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">contour_levels_gen</span>
    
    <span class="c1"># Create the plot based on method</span>
    <span class="k">if</span> <span class="n">plot_method</span> <span class="o">==</span> <span class="s1">&#39;pcolormesh&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">z</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Mask zero values for histogram data</span>
            <span class="n">data_masked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">data_to_plot</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data_to_plot</span><span class="p">)</span>
            <span class="n">plot_obj</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">x_edges</span><span class="p">,</span> <span class="n">y_edges</span><span class="p">,</span> <span class="n">data_masked</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">color_norm</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plot_obj</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">x_edges</span><span class="p">,</span> <span class="n">y_edges</span><span class="p">,</span> <span class="n">data_to_plot</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">color_norm</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">plot_method</span> <span class="o">==</span> <span class="s1">&#39;contourf&#39;</span><span class="p">:</span>
        <span class="n">plot_obj</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">x_mid</span><span class="p">,</span> <span class="n">y_mid</span><span class="p">,</span> <span class="n">data_to_plot</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">color_norm</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">plot_method</span> <span class="o">==</span> <span class="s1">&#39;contour&#39;</span><span class="p">:</span>
        <span class="n">plot_obj</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">x_mid</span><span class="p">,</span> <span class="n">y_mid</span><span class="p">,</span> <span class="n">data_to_plot</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">color_norm</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">)</span>
            
    <span class="c1"># Additional features (only when not using separate normalization for contour plots)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">separate</span> <span class="ow">or</span> <span class="n">plot_method</span> <span class="o">==</span> <span class="s1">&#39;pcolormesh&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fit_line</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scales</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
                <span class="n">x_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x_fit</span> <span class="o">=</span> <span class="n">x</span>
            <span class="k">if</span> <span class="n">scales</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
                <span class="n">y_fit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">y_fit</span> <span class="o">=</span> <span class="n">y</span>
                
            <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">r_value</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">x_fit</span><span class="p">,</span> <span class="n">y_fit</span><span class="p">)</span>
            <span class="n">x_fitted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">x_fit</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">x_fit</span><span class="p">)])</span>
            <span class="n">y_fitted</span> <span class="o">=</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">x_fitted</span> <span class="o">+</span> <span class="n">intercept</span>
            
            <span class="k">if</span> <span class="n">scales</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
                <span class="n">x_fitted</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">x_fitted</span>
                <span class="n">right_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">slope</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;$\log_</span><span class="si">{10}</span><span class="s1">x$&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">right_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">slope</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;$x$&#39;</span>
            <span class="k">if</span> <span class="n">scales</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
                <span class="n">y_fitted</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">y_fitted</span>
                <span class="n">left_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\log_</span><span class="si">{10}</span><span class="s1">y=$&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">left_label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$y=$&#39;</span>
                
            <span class="n">end_label</span> <span class="o">=</span>  <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$+$&#39;</span> <span class="k">if</span> <span class="n">intercept</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">intercept</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;$r\approx$&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">r_value</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;$\ \ p\leqslant$&#39;</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">p_value</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.01</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">p_value</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">0.01</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="mf">0.01</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">fit_line_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="n">left_label</span><span class="o">+</span><span class="n">right_label</span><span class="o">+</span><span class="n">end_label</span><span class="p">)</span>
            
            <span class="n">_log_or_linear_plot</span><span class="p">(</span><span class="n">scales</span><span class="p">,</span> <span class="n">axes</span><span class="p">)(</span><span class="n">x_fitted</span><span class="p">,</span> <span class="n">y_fitted</span><span class="p">,</span> <span class="o">**</span><span class="n">fit_line_kwargs</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">mean_std</span><span class="p">:</span>
            <span class="n">unlog_x_mean</span><span class="p">,</span> <span class="n">x_cap</span><span class="p">,</span> <span class="n">x_label</span> <span class="o">=</span> <span class="n">_mean_std_params</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">scales</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">unlog_y_mean</span><span class="p">,</span> <span class="n">y_cap</span><span class="p">,</span> <span class="n">y_label</span> <span class="o">=</span> <span class="n">_mean_std_params</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">scales</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                
            <span class="n">axes</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">unlog_x_mean</span><span class="p">,</span> <span class="n">unlog_y_mean</span><span class="p">,</span> <span class="n">xerr</span><span class="o">=</span><span class="n">x_cap</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">y_cap</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">x_label</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">y_label</span><span class="p">,</span> <span class="o">**</span><span class="n">mean_std_errorbar_kwargs</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">mean_std_line</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">separate</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span> <span class="ow">or</span> <span class="n">mean_std_line</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
                <span class="n">unlog_y_means</span><span class="p">,</span> <span class="n">y_caps</span> <span class="o">=</span> <span class="n">_mean_std_line_params</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x_edges</span><span class="p">,</span> <span class="n">scales</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="n">mean_std_line_method</span><span class="p">)</span>
                <span class="n">axes</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x_mid</span><span class="p">,</span> <span class="n">unlog_y_means</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">y_caps</span><span class="p">,</span> <span class="o">**</span><span class="n">mean_std_line_kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">separate</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span> <span class="ow">or</span> <span class="n">mean_std_line</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="n">unlog_x_means</span><span class="p">,</span> <span class="n">x_caps</span> <span class="o">=</span> <span class="n">_mean_std_line_params</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y_edges</span><span class="p">,</span> <span class="n">scales</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="n">mean_std_line_method</span><span class="p">)</span>
                <span class="n">axes</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">unlog_x_means</span><span class="p">,</span> <span class="n">y_mid</span><span class="p">,</span> <span class="n">xerr</span><span class="o">=</span><span class="n">x_caps</span><span class="p">,</span> <span class="o">**</span><span class="n">mean_std_line_kwargs</span><span class="p">)</span>
        
    <span class="c1"># Set axis scales</span>
    <span class="k">if</span> <span class="n">scales</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">scales</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">plot_obj</span></div>


    
<div class="viewcode-block" id="plot_hist3d_slices">
<a class="viewcode-back" href="../../../source/spcphys_common_functions.processing.html#spcphys_common_functions.processing.plot_tools.plot_hist3d_slices">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_hist3d_slices</span><span class="p">(</span>
    <span class="n">axes</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">|</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">|</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">|</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">,</span> 
    <span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">|</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="o">|</span><span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">least_samples_per_cell</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">scales</span><span class="p">:</span> <span class="nb">list</span><span class="o">|</span><span class="nb">tuple</span><span class="o">|</span><span class="nb">str</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">norm_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;sum&#39;</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">color_norm_type</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">color_norm_range</span><span class="p">:</span> <span class="nb">list</span><span class="o">|</span><span class="nb">tuple</span><span class="o">|</span><span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
    <span class="n">bins</span><span class="p">:</span> <span class="nb">int</span><span class="o">|</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">|</span><span class="nb">list</span><span class="o">|</span><span class="nb">str</span><span class="o">=</span><span class="s1">&#39;freedman&#39;</span><span class="p">,</span> 
    <span class="n">slice_direction</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">slice_positions</span><span class="p">:</span> <span class="nb">list</span><span class="o">|</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">|</span><span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">slice_count</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">plot_method</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;contour&#39;</span><span class="p">,</span> <span class="s1">&#39;contourf&#39;</span><span class="p">]</span><span class="o">=</span><span class="s1">&#39;contourf&#39;</span><span class="p">,</span>
    <span class="n">slice_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="o">|</span><span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Plot 3D histogram as slices in 3D space. If w is provided, overplot w as color.</span>

<span class="sd">    :param axes: The matplotlib 3D axes to plot on (must be created with projection=&#39;3d&#39;).</span>
<span class="sd">    :param x: The x-axis data, can be a numpy array or an astropy Quantity.</span>
<span class="sd">    :param y: The y-axis data, can be a numpy array or an astropy Quantity.</span>
<span class="sd">    :param z: The z-axis data, can be a numpy array or an astropy Quantity.</span>
<span class="sd">    :param w: The w-axis data for coloring, can be a numpy array or an astropy Quantity. Default is None.</span>
<span class="sd">    :param least_samples_per_cell: The least number of samples per cell to plot, valid only when w is not None. Default is 1.</span>
<span class="sd">    :param scales: The scales for the axes, can be &#39;linear&#39; or &#39;log&#39;. Default is &#39;linear&#39;.</span>
<span class="sd">    :param norm_type: The normalization type, can be &#39;max&#39;, &#39;sum&#39;, or None. Default is None.</span>
<span class="sd">    :param color_norm_type: The color normalization type, can be &#39;linear&#39; or &#39;log&#39;. Default is &#39;linear&#39;.</span>
<span class="sd">    :param color_norm_range: The range for color normalization. Default is None.</span>
<span class="sd">    :param bins: The bins for the histogram, can be an integer, numpy array, list, or a string (&#39;freedman&#39;, &#39;scott&#39;, &#39;knuth&#39;, &#39;blocks&#39;). Default is &#39;freedman&#39;.</span>
<span class="sd">    :param slice_direction: The direction to slice (&#39;x&#39;, &#39;y&#39;, or &#39;z&#39;). Default is &#39;z&#39;.</span>
<span class="sd">    :param slice_positions: Specific positions to slice at in original data coordinates. If None, will use slice_count to generate evenly spaced slices. Default is None.</span>
<span class="sd">    :param slice_count: Number of slices to generate if slice_positions is None. Default is 5.</span>
<span class="sd">    :param plot_method: The plotting method (&#39;contour&#39; or &#39;contourf&#39;). Default is &#39;contourf&#39;.</span>
<span class="sd">    :param slice_kwargs: Additional arguments for the plotting method. Default varies by method.</span>
<span class="sd">    :param alpha: Transparency of the slices. Default is 0.7.</span>
<span class="sd">    </span>
<span class="sd">    :return slice_objects: List of plot objects for each slice.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="c1"># Validation</span>
    <span class="k">if</span> <span class="n">least_samples_per_cell</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;least_samples_per_cell must be a positive integer.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">norm_type</span> <span class="ow">and</span> <span class="n">norm_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;max&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;norm_type must be &#39;max&#39;, &#39;sum&#39; or None.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">color_norm_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;log&#39;</span><span class="p">,</span> <span class="s1">&#39;linear&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;color_norm_type must be &#39;log&#39; or &#39;linear&#39;.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">bins</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;freedman&#39;</span><span class="p">,</span> <span class="s1">&#39;scott&#39;</span><span class="p">,</span> <span class="s1">&#39;knuth&#39;</span><span class="p">,</span> <span class="s1">&#39;blocks&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;bins must be &#39;freedman&#39;, &#39;scott&#39;, &#39;knuth&#39;, &#39;blocks&#39;, an integer, a numpy array, or a list.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">slice_direction</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;slice_direction must be &#39;x&#39;, &#39;y&#39;, or &#39;z&#39;.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">plot_method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;contour&#39;</span><span class="p">,</span> <span class="s1">&#39;contourf&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;plot_method must be &#39;contour&#39; or &#39;contourf&#39;.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">norm_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">w</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;norm_type cannot be used when w is provided.&quot;</span><span class="p">)</span>
    
    <span class="c1"># Check if axes is 3D</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="s1">&#39;zaxis&#39;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;axes must be a 3D axes (created with projection=&#39;3d&#39;).&quot;</span><span class="p">)</span>
        
    <span class="c1"># Set default kwargs based on plot method</span>
    <span class="k">if</span> <span class="n">slice_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">slice_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    
    <span class="k">if</span> <span class="n">plot_method</span> <span class="o">==</span> <span class="s1">&#39;contourf&#39;</span><span class="p">:</span>
        <span class="n">slice_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;cmap&#39;</span><span class="p">,</span> <span class="s1">&#39;jet&#39;</span><span class="p">)</span>
        <span class="n">slice_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">plot_method</span> <span class="o">==</span> <span class="s1">&#39;contour&#39;</span><span class="p">:</span>
        <span class="n">slice_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;colors&#39;</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>  <span class="c1"># contour默认使用黑色线条</span>
        <span class="n">slice_kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
        <span class="c1"># 如果用户指定了cmap，则移除colors</span>
        <span class="k">if</span> <span class="s1">&#39;cmap&#39;</span> <span class="ow">in</span> <span class="n">slice_kwargs</span><span class="p">:</span>
            <span class="n">slice_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;colors&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="c1"># Convert quantities to values</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">value</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">value</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">):</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">value</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">):</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">value</span>
    
    <span class="c1"># Handle bins and scales</span>
    <span class="n">bins</span> <span class="o">=</span> <span class="p">[</span><span class="n">bins</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">bins</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">))</span> <span class="k">else</span> <span class="n">bins</span>
    <span class="n">scales</span> <span class="o">=</span> <span class="p">[</span><span class="n">scales</span><span class="p">,</span> <span class="n">scales</span><span class="p">,</span> <span class="n">scales</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scales</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">w</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">scales</span><span class="p">,</span> <span class="n">scales</span><span class="p">,</span> <span class="n">scales</span><span class="p">,</span> <span class="n">scales</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scales</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">scales</span>
    
    <span class="c1"># Apply log transformation to data if needed (replace log axes with log data)</span>
    <span class="n">x_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="n">scales</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span> <span class="k">else</span> <span class="n">x</span>
    <span class="n">y_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">if</span> <span class="n">scales</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span> <span class="k">else</span> <span class="n">y</span>
    <span class="n">z_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="k">if</span> <span class="n">scales</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span> <span class="k">else</span> <span class="n">z</span>
    
    <span class="c1"># Check for invalid log values</span>
    <span class="k">if</span> <span class="n">scales</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Logarithmic scale for x requires all x values to be positive.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">scales</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">y</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Logarithmic scale for y requires all y values to be positive.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">scales</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">z</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Logarithmic scale for z requires all z values to be positive.&quot;</span><span class="p">)</span>
    
    <span class="c1"># Determine bins for each axis (use transformed data for log scales)</span>
    <span class="n">bins_x</span> <span class="o">=</span> <span class="n">_determine_bins</span><span class="p">(</span><span class="n">x_plot</span><span class="p">,</span> <span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;linear&#39;</span><span class="p">)</span>  <span class="c1"># Always use linear for transformed data</span>
    <span class="n">bins_y</span> <span class="o">=</span> <span class="n">_determine_bins</span><span class="p">(</span><span class="n">y_plot</span><span class="p">,</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;linear&#39;</span><span class="p">)</span>
    <span class="n">bins_z</span> <span class="o">=</span> <span class="n">_determine_bins</span><span class="p">(</span><span class="n">z_plot</span><span class="p">,</span> <span class="n">bins</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s1">&#39;linear&#39;</span><span class="p">)</span>
    
    <span class="c1"># Create 3D histogram using transformed data</span>
    <span class="n">hist_3d</span><span class="p">,</span> <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogramdd</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">x_plot</span><span class="p">,</span> <span class="n">y_plot</span><span class="p">,</span> <span class="n">z_plot</span><span class="p">]),</span> <span class="n">bins</span><span class="o">=</span><span class="p">[</span><span class="n">bins_x</span><span class="p">,</span> <span class="n">bins_y</span><span class="p">,</span> <span class="n">bins_z</span><span class="p">])</span>
    <span class="n">x_edges</span><span class="p">,</span> <span class="n">y_edges</span><span class="p">,</span> <span class="n">z_edges</span> <span class="o">=</span> <span class="n">edges</span>
    
    <span class="k">if</span> <span class="n">hist_3d</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No enough data to plot 3D histogram.&quot;</span><span class="p">)</span>
        
    <span class="c1"># Calculate midpoints</span>
    <span class="n">x_mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">x_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">y_mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">y_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">z_mid</span> <span class="o">=</span> <span class="p">(</span><span class="n">z_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">z_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    
    <span class="c1"># Handle w data if provided</span>
    <span class="k">if</span> <span class="n">w</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">w_scaled</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="k">if</span> <span class="n">scales</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span> <span class="k">else</span> <span class="n">w</span>
        <span class="n">w_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">hist_3d</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_edges</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_edges</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">z_edges</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="n">x_plot</span> <span class="o">&gt;</span> <span class="n">x_edges</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x_plot</span> <span class="o">&lt;=</span> <span class="n">x_edges</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> 
                           <span class="p">(</span><span class="n">y_plot</span> <span class="o">&gt;</span> <span class="n">y_edges</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y_plot</span> <span class="o">&lt;=</span> <span class="n">y_edges</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> 
                           <span class="p">(</span><span class="n">z_plot</span> <span class="o">&gt;</span> <span class="n">z_edges</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">z_plot</span> <span class="o">&lt;=</span> <span class="n">z_edges</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
                    <span class="n">w_ijk</span> <span class="o">=</span> <span class="n">w_scaled</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">w_ijk</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">least_samples_per_cell</span><span class="p">:</span>
                        <span class="n">w_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">w_ijk</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">w_mat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        
        <span class="n">w_mat</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">w_mat</span> <span class="k">if</span> <span class="n">scales</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span> <span class="k">else</span> <span class="n">w_mat</span>
        <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">w_mat</span>
        
        <span class="c1"># Set color normalization for w data</span>
        <span class="k">if</span> <span class="n">scales</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
            <span class="n">color_norm</span> <span class="o">=</span> <span class="n">LogNorm</span><span class="p">(</span><span class="o">*</span><span class="n">color_norm_range</span><span class="p">)</span> <span class="k">if</span> <span class="n">color_norm_range</span> <span class="k">else</span> <span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">w_mat</span><span class="p">),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">w_mat</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">color_norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="o">*</span><span class="n">color_norm_range</span><span class="p">)</span> <span class="k">if</span> <span class="n">color_norm_range</span> <span class="k">else</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">w_mat</span><span class="p">),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">w_mat</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">hist_3d</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="c1"># Apply normalization</span>
        <span class="k">if</span> <span class="n">norm_type</span> <span class="o">==</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
            <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">data_to_plot</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">norm_type</span> <span class="o">==</span> <span class="s1">&#39;sum&#39;</span><span class="p">:</span>
            <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">data_to_plot</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">)</span>
        
        <span class="c1"># Set color normalization</span>
        <span class="k">if</span> <span class="n">color_norm_type</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
            <span class="n">valid_data</span> <span class="o">=</span> <span class="n">data_to_plot</span><span class="p">[</span><span class="n">data_to_plot</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No valid data for log normalization.&quot;</span><span class="p">)</span>
            <span class="n">color_norm</span> <span class="o">=</span> <span class="n">LogNorm</span><span class="p">(</span><span class="o">*</span><span class="n">color_norm_range</span><span class="p">)</span> <span class="k">if</span> <span class="n">color_norm_range</span> <span class="k">else</span> <span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">valid_data</span><span class="p">),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">valid_data</span><span class="p">))</span>
            <span class="n">lower_level</span><span class="p">,</span> <span class="n">upper_level</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">valid_data</span><span class="p">))),</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">valid_data</span><span class="p">)))</span>
            <span class="n">contour_levels_gen</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">lower_level</span><span class="p">,</span> <span class="n">upper_level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">color_norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="o">*</span><span class="n">color_norm_range</span><span class="p">)</span> <span class="k">if</span> <span class="n">color_norm_range</span> <span class="k">else</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">))</span>
            <span class="n">lower_level</span><span class="p">,</span> <span class="n">upper_level</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">)</span>
            <span class="n">contour_levels_gen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lower_level</span><span class="p">,</span> <span class="n">upper_level</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    
    <span class="c1"># Set default contour levels</span>
    <span class="k">if</span> <span class="s1">&#39;levels&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">slice_kwargs</span> <span class="ow">and</span> <span class="n">w</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">slice_kwargs</span><span class="p">[</span><span class="s1">&#39;levels&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">contour_levels_gen</span>
    
    <span class="c1"># Determine slice positions</span>
    <span class="k">if</span> <span class="n">slice_positions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># User specified positions - transform them to histogram coordinates if needed</span>
        <span class="n">slice_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">slice_positions</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">slice_direction</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span> <span class="ow">and</span> <span class="n">scales</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
            <span class="n">slice_positions_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">slice_positions</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">slice_direction</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span> <span class="ow">and</span> <span class="n">scales</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
            <span class="n">slice_positions_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">slice_positions</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">slice_direction</span> <span class="o">==</span> <span class="s1">&#39;z&#39;</span> <span class="ow">and</span> <span class="n">scales</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
            <span class="n">slice_positions_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">slice_positions</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">slice_positions_plot</span> <span class="o">=</span> <span class="n">slice_positions</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Auto-generate slice positions</span>
        <span class="k">if</span> <span class="n">slice_direction</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
            <span class="n">slice_positions_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x_edges</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">slice_count</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">slice_direction</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
            <span class="n">slice_positions_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">y_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">y_edges</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">slice_count</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># slice_direction == &#39;z&#39;</span>
            <span class="n">slice_positions_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">z_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">z_edges</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">slice_count</span><span class="p">)</span>
    
    <span class="c1"># Get current view to determine depth sorting for drawing order</span>
    <span class="n">elev</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">elev</span>
    <span class="n">azim</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">azim</span>
    
    <span class="n">elev_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">elev</span><span class="p">)</span>
    <span class="n">azim_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">azim</span><span class="p">)</span>

    <span class="c1"># 计算完整的3D观察方向向量 (单位向量)</span>
    <span class="n">view_dir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">elev_rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">azim_rad</span><span class="p">),</span>  <span class="c1"># X分量</span>
        <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">elev_rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">azim_rad</span><span class="p">),</span>  <span class="c1"># Y分量</span>
        <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">elev_rad</span><span class="p">)</span>                     <span class="c1"># Z分量</span>
    <span class="p">])</span>

    <span class="k">if</span> <span class="n">slice_direction</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
        <span class="c1"># X切片：使用完整的X观察分量，按投影深度降序排序</span>
        <span class="n">depth_proj</span> <span class="o">=</span> <span class="n">slice_positions_plot</span> <span class="o">*</span> <span class="n">view_dir</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sorted_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">depth_proj</span><span class="p">)</span>  <span class="c1"># 负号实现降序</span>
        
    <span class="k">elif</span> <span class="n">slice_direction</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
        <span class="c1"># Y切片：使用完整的Y观察分量</span>
        <span class="n">depth_proj</span> <span class="o">=</span> <span class="n">slice_positions_plot</span> <span class="o">*</span> <span class="n">view_dir</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sorted_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">depth_proj</span><span class="p">)</span>  <span class="c1"># 降序</span>
        
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># slice_direction == &#39;z&#39;</span>
        <span class="c1"># Z切片：使用完整的Z观察分量</span>
        <span class="n">depth_proj</span> <span class="o">=</span> <span class="n">slice_positions_plot</span> <span class="o">*</span> <span class="n">view_dir</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">sorted_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">depth_proj</span><span class="p">)</span>  <span class="c1"># 降序</span>
    
    <span class="c1"># Reorder slice positions for proper depth sorting (draw far to near)</span>
    <span class="n">slice_positions_plot</span> <span class="o">=</span> <span class="n">slice_positions_plot</span><span class="p">[</span><span class="n">sorted_indices</span><span class="p">]</span>
    
    <span class="n">slice_objects</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># Create slices in depth-sorted order (far to near)</span>
    <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">slice_positions_plot</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">slice_direction</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
            <span class="c1"># Find closest x index</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x_mid</span> <span class="o">-</span> <span class="n">pos</span><span class="p">))</span>
            <span class="n">slice_data</span> <span class="o">=</span> <span class="n">data_to_plot</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>  <span class="c1"># Shape: (n_y, n_z)</span>
            
            <span class="n">Y_mid_mesh</span><span class="p">,</span> <span class="n">Z_mid_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">y_mid</span><span class="p">,</span> <span class="n">z_mid</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">plot_method</span> <span class="o">==</span> <span class="s1">&#39;contourf&#39;</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">Y_mid_mesh</span><span class="p">,</span> <span class="n">Z_mid_mesh</span><span class="p">,</span> <span class="n">slice_data</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">zdir</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">color_norm</span><span class="p">,</span> <span class="o">**</span><span class="n">slice_kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># contour</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">Y_mid_mesh</span><span class="p">,</span> <span class="n">Z_mid_mesh</span><span class="p">,</span> <span class="n">slice_data</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">zdir</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">color_norm</span><span class="p">,</span> <span class="o">**</span><span class="n">slice_kwargs</span><span class="p">)</span>
            
        <span class="k">elif</span> <span class="n">slice_direction</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
            <span class="c1"># Find closest y index</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_mid</span> <span class="o">-</span> <span class="n">pos</span><span class="p">))</span>
            <span class="n">slice_data</span> <span class="o">=</span> <span class="n">data_to_plot</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># Shape: (n_x, n_z)</span>
            
            <span class="n">X_mid_mesh</span><span class="p">,</span> <span class="n">Z_mid_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_mid</span><span class="p">,</span> <span class="n">z_mid</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">plot_method</span> <span class="o">==</span> <span class="s1">&#39;contourf&#39;</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">X_mid_mesh</span><span class="p">,</span> <span class="n">Z_mid_mesh</span><span class="p">,</span> <span class="n">slice_data</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">zdir</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">color_norm</span><span class="p">,</span> <span class="o">**</span><span class="n">slice_kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># contour</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">X_mid_mesh</span><span class="p">,</span> <span class="n">Z_mid_mesh</span><span class="p">,</span> <span class="n">slice_data</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">zdir</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">color_norm</span><span class="p">,</span> <span class="o">**</span><span class="n">slice_kwargs</span><span class="p">)</span>
            
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># slice_direction == &#39;z&#39;</span>
            <span class="c1"># Find closest z index</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">z_mid</span> <span class="o">-</span> <span class="n">pos</span><span class="p">))</span>
            <span class="n">slice_data</span> <span class="o">=</span> <span class="n">data_to_plot</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">idx</span><span class="p">]</span>  <span class="c1"># Shape: (n_x, n_y)</span>
            
            <span class="n">X_mid_mesh</span><span class="p">,</span> <span class="n">Y_mid_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_mid</span><span class="p">,</span> <span class="n">y_mid</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">plot_method</span> <span class="o">==</span> <span class="s1">&#39;contourf&#39;</span><span class="p">:</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">X_mid_mesh</span><span class="p">,</span> <span class="n">Y_mid_mesh</span><span class="p">,</span> <span class="n">slice_data</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">zdir</span><span class="o">=</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">color_norm</span><span class="p">,</span> <span class="o">**</span><span class="n">slice_kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># contour</span>
                <span class="n">obj</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">X_mid_mesh</span><span class="p">,</span> <span class="n">Y_mid_mesh</span><span class="p">,</span> <span class="n">slice_data</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">zdir</span><span class="o">=</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">pos</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">color_norm</span><span class="p">,</span> <span class="o">**</span><span class="n">slice_kwargs</span><span class="p">)</span>
        
        <span class="n">slice_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">slice_objects</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_auto_downsample</span><span class="p">(</span><span class="n">axes</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">|</span><span class="nb">list</span><span class="o">|</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">|</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">,</span> <span class="n">max_dens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Downsamples the data points to ensure the density of points on the plot does not exceed a specified maximum density.</span>

<span class="sd">    :param axes: The matplotlib axes object where the data will be plotted.</span>
<span class="sd">    :param x: The x-coordinates of the data points. Can be a list of datetime objects.</span>
<span class="sd">    :param y: The y-coordinates of the data points.</span>
<span class="sd">    :param max_dens: The maximum allowed number of points per inch on the plot.</span>
<span class="sd">    </span>
<span class="sd">    :return x: The downsampled x (preserves original datetime type if applicable).</span>
<span class="sd">    :return y: The downsampled y.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">examine_size</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># axes_width / examine_size</span>

    <span class="c1"># Convert x to numpy array and handle datetime types</span>
    <span class="n">x_original</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">x_num</span> <span class="o">=</span> <span class="n">x_original</span>  <span class="c1"># Initialize numerical x for histogram</span>

    <span class="c1"># Handle datetime conversion to numerical values</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x_original</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">x_original</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">):</span>
        <span class="n">x_num</span> <span class="o">=</span> <span class="n">x_original</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;datetime64[ns]&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x_original</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">x_original</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="nb">object</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_original</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x_original</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">datetime</span><span class="p">):</span>
            <span class="n">x_num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dt</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">x_original</span><span class="o">.</span><span class="n">ravel</span><span class="p">()])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x_original</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="c1"># Handle Quantity types</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x_original</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">):</span>
        <span class="n">x_num</span> <span class="o">=</span> <span class="n">x_original</span><span class="o">.</span><span class="n">value</span>

    <span class="c1"># Mask NaN values based on y</span>
    <span class="n">nan_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">y</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">y_nan</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">nan_mask</span><span class="p">]</span>
    <span class="n">y_non_nan</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="o">~</span><span class="n">nan_mask</span><span class="p">]</span>
    <span class="n">x_non_nan_original</span> <span class="o">=</span> <span class="n">x_original</span><span class="p">[</span><span class="o">~</span><span class="n">nan_mask</span><span class="p">]</span>
    <span class="n">x_non_nan_num</span> <span class="o">=</span> <span class="n">x_num</span><span class="p">[</span><span class="o">~</span><span class="n">nan_mask</span><span class="p">]</span>

    <span class="c1"># Calculate histogram bins based on numerical x values</span>
    <span class="n">axes_width</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">get_position</span><span class="p">()</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">axes</span><span class="o">.</span><span class="n">get_figure</span><span class="p">()</span><span class="o">.</span><span class="n">get_size_inches</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">hists</span><span class="p">,</span> <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">x_non_nan_num</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">axes_width</span><span class="p">)</span><span class="o">*</span><span class="n">examine_size</span><span class="p">)</span>
    <span class="n">high_density_bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">hists</span> <span class="o">&gt;</span> <span class="n">max_dens</span><span class="o">/</span><span class="n">examine_size</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">high_density_bins</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x_original</span><span class="p">,</span> <span class="n">y</span>

    <span class="n">low_density_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_non_nan_num</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">downsampled_indices</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Downsample high-density bins</span>
    <span class="k">for</span> <span class="n">bin_index</span> <span class="ow">in</span> <span class="n">high_density_bins</span><span class="p">:</span>
        <span class="n">bin_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_non_nan_num</span> <span class="o">&gt;=</span> <span class="n">bin_edges</span><span class="p">[</span><span class="n">bin_index</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x_non_nan_num</span> <span class="o">&lt;</span> <span class="n">bin_edges</span><span class="p">[</span><span class="n">bin_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">bin_mask</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">low_density_mask</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">num_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_dens</span><span class="o">/</span><span class="n">examine_size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">num_samples</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">num_samples</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">downsampled_indices</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">num_samples</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">))</span>

    <span class="c1"># Combine indices and sort</span>
    <span class="n">non_nan_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">flatnonzero</span><span class="p">(</span><span class="n">low_density_mask</span><span class="p">),</span> <span class="n">downsampled_indices</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">non_nan_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">non_nan_indices</span><span class="p">)</span>

    <span class="c1"># Reconstruct final arrays preserving original types</span>
    <span class="n">final_x_unsorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">x_non_nan_original</span><span class="p">[</span><span class="n">non_nan_indices</span><span class="p">],</span> <span class="n">x_original</span><span class="p">[</span><span class="n">nan_mask</span><span class="p">]])</span>
    <span class="n">final_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">final_x_unsorted</span><span class="p">)</span>
    <span class="n">final_x</span> <span class="o">=</span> <span class="n">final_x_unsorted</span><span class="p">[</span><span class="n">final_indices</span><span class="p">]</span>
    <span class="n">final_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">y_non_nan</span><span class="p">[</span><span class="n">non_nan_indices</span><span class="p">],</span> <span class="n">y_nan</span><span class="p">])[</span><span class="n">final_indices</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">final_x</span><span class="p">,</span> <span class="n">final_y</span>


<div class="viewcode-block" id="plot">
<a class="viewcode-back" href="../../../source/spcphys_common_functions.processing.html#spcphys_common_functions.processing.plot_tools.plot">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">|</span><span class="nb">list</span><span class="o">|</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">|</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">,</span> <span class="n">axes</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="o">|</span><span class="kc">None</span> <span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">auto_downsample</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">max_dens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Plot x and y data.</span>
<span class="sd">    </span>
<span class="sd">    :param x: The x-axis data.</span>
<span class="sd">    :param y: The y-axis data.</span>
<span class="sd">    :param axes: The matplotlib axes to plot on. Default is None.</span>
<span class="sd">    :param scale: The scale for the plot, can be &#39;linear&#39; or &#39;log&#39;. Default is &#39;linear&#39;.</span>
<span class="sd">    :param auto_downsample: Whether to automatically downsample the data. Default is True.</span>
<span class="sd">    :param max_dens: The maximum number of data points per inch. Default is 1000.</span>
<span class="sd">    :param plot_kwargs: Additional arguments for the plot function.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="k">if</span> <span class="n">axes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span>
    
    <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
        <span class="n">plot_func</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">semilogy</span>
    <span class="k">elif</span> <span class="n">scale</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
        <span class="n">plot_func</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span>
    
    <span class="k">if</span> <span class="n">auto_downsample</span><span class="p">:</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">_auto_downsample</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">max_dens</span><span class="p">)</span>
        
    <span class="n">plot_func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">)</span></div>




<div class="viewcode-block" id="plot_mesh1d_ts">
<a class="viewcode-back" href="../../../source/spcphys_common_functions.processing.html#spcphys_common_functions.processing.plot_tools.plot_mesh1d_ts">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_mesh1d_ts</span><span class="p">(</span><span class="n">axes</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">|</span><span class="n">List</span><span class="p">[</span><span class="n">datetime</span><span class="p">],</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">|</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="o">|</span><span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">|</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">],</span> <span class="n">z</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">|</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="o">|</span><span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">|</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">],</span>
                   <span class="n">width</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">timedelta</span><span class="p">]</span><span class="o">|</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">|</span><span class="n">timedelta</span><span class="o">|</span><span class="nb">float</span><span class="o">|</span><span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">norm</span><span class="p">:</span> <span class="nb">str</span><span class="o">|</span><span class="n">LogNorm</span><span class="o">|</span><span class="n">Normalize</span> <span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">pcolormesh_kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">QuadMesh</span><span class="p">:</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Plot a 1D mesh plot with time as the x-axis.</span>
<span class="sd">    </span>
<span class="sd">    :param axes: The matplotlib axes to plot on.</span>
<span class="sd">    :param t: The time data.</span>
<span class="sd">    :param y: The y-axis data in shape (t, y) or (y,). Can be a list if length of y varies with time.</span>
<span class="sd">    :param z: The z-axis data in shape (t, y). Can be a list if length of y varies with time.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">INVALID_DIFF_PERCENT</span> <span class="o">=</span> <span class="mf">0.1</span>
    
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">t</span>
    
    <span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">t_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">t_diff_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">t_diff</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">t_diff</span> <span class="o">&lt;</span> <span class="n">t_diff_mean</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">INVALID_DIFF_PERCENT</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">t_diff</span> <span class="o">&gt;</span> <span class="n">t_diff_mean</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">INVALID_DIFF_PERCENT</span><span class="p">)):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The time intervals are not equal. Using the difference of every two points as width.&quot;</span><span class="p">)</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">t_diff</span><span class="p">,</span> <span class="p">[</span><span class="n">t_diff</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span>
            
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">width</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The width must have the same length as t - 1.&quot;</span><span class="p">)</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">width</span><span class="p">)</span>
            
    <span class="k">if</span> <span class="n">norm</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">z</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">norm</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">z</span><span class="p">[</span><span class="n">z</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">vmax</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">z</span><span class="p">))</span>
            
    <span class="k">if</span> <span class="s1">&#39;norm&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pcolormesh_kwargs</span><span class="p">:</span>
        <span class="n">pcolormesh_kwargs</span><span class="p">[</span><span class="s1">&#39;norm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm</span>
    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Iterable</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">yi_valid_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">yi_valid_indices</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">quadmesh</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">([</span><span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">width</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">width</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="mi">4</span><span class="o">*</span><span class="mi">3</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">yi_valid_indices</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(([</span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">yi_valid_indices</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">yi_valid_indices</span><span class="p">]]))</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="o">**</span><span class="n">pcolormesh_kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">quadmesh</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="o">**</span><span class="n">pcolormesh_kwargs</span><span class="p">)</span>
            
    <span class="k">return</span> <span class="n">quadmesh</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, NyankoSong.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>